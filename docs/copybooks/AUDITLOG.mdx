---
title: "AUDITLOG"
description: "Audit Trail Record Definitions - standard structure for tracking system events, user actions, and transactions"
---

## Overview

AUDITLOG is a copybook that defines the standard audit trail record structure used throughout the portfolio management system. It provides a consistent format for recording system events, user actions, and transaction activities, supporting compliance, security monitoring, and troubleshooting requirements.

The audit record captures comprehensive information including timestamps, user identification, action types, success/failure status, and before/after images of data changes. This enables full traceability of all significant operations performed within the system.

## Record Layout

```
+------------------------------------------------------------------+
| AUDIT-RECORD (388 bytes total)                                   |
+------------------------------------------------------------------+
| AUD-HEADER (58 bytes)                                            |
|   +------------------------------------------------------------+ |
|   | AUD-TIMESTAMP (26) | AUD-SYSTEM-ID (8) | AUD-USER-ID (8)   | |
|   | AUD-PROGRAM (8)    | AUD-TERMINAL (8)                      | |
|   +------------------------------------------------------------+ |
+------------------------------------------------------------------+
| AUD-TYPE (4) | AUD-ACTION (8) | AUD-STATUS (4)                   |
+------------------------------------------------------------------+
| AUD-KEY-INFO (18 bytes)                                          |
|   +------------------------------------------------------------+ |
|   | AUD-PORTFOLIO-ID (8) | AUD-ACCOUNT-NO (10)                 | |
|   +------------------------------------------------------------+ |
+------------------------------------------------------------------+
| AUD-BEFORE-IMAGE (100) | AUD-AFTER-IMAGE (100) | AUD-MESSAGE(100)|
+------------------------------------------------------------------+
```

## Data Structure

### AUDIT-RECORD (Level 01)

The main audit record containing all audit trail information.

### AUD-HEADER Group (Level 05)

| Level | Name | Picture | Description |
|-------|------|---------|-------------|
| 05 | AUD-HEADER | - | Header information group |
| 10 | AUD-TIMESTAMP | X(26) | Event timestamp (format: YYYY-MM-DD-HH.MM.SS.NNNNNN) |
| 10 | AUD-SYSTEM-ID | X(8) | System/subsystem identifier |
| 10 | AUD-USER-ID | X(8) | User who performed the action |
| 10 | AUD-PROGRAM | X(8) | Program that generated the audit |
| 10 | AUD-TERMINAL | X(8) | Terminal ID (for online transactions) |

### AUD-TYPE (Level 05)

| Level | Name | Picture | Description |
|-------|------|---------|-------------|
| 05 | AUD-TYPE | X(4) | Type of audit event |

**88-Level Condition Names:**

| Condition | Value | Description |
|-----------|-------|-------------|
| AUD-TRANSACTION | 'TRAN' | Business transaction |
| AUD-USER-ACTION | 'USER' | User-initiated action |
| AUD-SYSTEM-EVENT | 'SYST' | System-generated event |

### AUD-ACTION (Level 05)

| Level | Name | Picture | Description |
|-------|------|---------|-------------|
| 05 | AUD-ACTION | X(8) | Action performed |

**88-Level Condition Names:**

| Condition | Value | Description |
|-----------|-------|-------------|
| AUD-CREATE | 'CREATE  ' | Record creation |
| AUD-UPDATE | 'UPDATE  ' | Record modification |
| AUD-DELETE | 'DELETE  ' | Record deletion |
| AUD-INQUIRE | 'INQUIRE ' | Read-only access |
| AUD-LOGIN | 'LOGIN   ' | User login |
| AUD-LOGOUT | 'LOGOUT  ' | User logout |
| AUD-STARTUP | 'STARTUP ' | System/program startup |
| AUD-SHUTDOWN | 'SHUTDOWN' | System/program shutdown |

### AUD-STATUS (Level 05)

| Level | Name | Picture | Description |
|-------|------|---------|-------------|
| 05 | AUD-STATUS | X(4) | Outcome of the action |

**88-Level Condition Names:**

| Condition | Value | Description |
|-----------|-------|-------------|
| AUD-SUCCESS | 'SUCC' | Action completed successfully |
| AUD-FAILURE | 'FAIL' | Action failed |
| AUD-WARNING | 'WARN' | Action completed with warnings |

### AUD-KEY-INFO Group (Level 05)

| Level | Name | Picture | Description |
|-------|------|---------|-------------|
| 05 | AUD-KEY-INFO | - | Key identification fields |
| 10 | AUD-PORTFOLIO-ID | X(8) | Portfolio identifier |
| 10 | AUD-ACCOUNT-NO | X(10) | Account number |

### Data Image Fields (Level 05)

| Level | Name | Picture | Description |
|-------|------|---------|-------------|
| 05 | AUD-BEFORE-IMAGE | X(100) | Data state before the action |
| 05 | AUD-AFTER-IMAGE | X(100) | Data state after the action |
| 05 | AUD-MESSAGE | X(100) | Descriptive message or details |

## Usage Examples

### Creating an Audit Record

```cobol
WORKING-STORAGE SECTION.
    COPY AUDITLOG.

PROCEDURE DIVISION.
    INITIALIZE AUDIT-RECORD
    
    ACCEPT AUD-TIMESTAMP FROM TIME STAMP
    MOVE 'MYPROGRAM' TO AUD-PROGRAM
    MOVE WS-USER-ID  TO AUD-USER-ID
    MOVE 'PORTMGMT' TO AUD-SYSTEM-ID
    
    SET AUD-TRANSACTION TO TRUE
    SET AUD-CREATE TO TRUE
    SET AUD-SUCCESS TO TRUE
    
    MOVE WS-PORTFOLIO-ID TO AUD-PORTFOLIO-ID
    MOVE WS-ACCOUNT-NO TO AUD-ACCOUNT-NO
    
    MOVE 'New portfolio created' TO AUD-MESSAGE
    
    CALL 'AUDPROC' USING AUDIT-RECORD
```

### Using 88-Level Conditions

```cobol
* Setting action type
SET AUD-UPDATE TO TRUE

* Checking status
IF AUD-SUCCESS
    DISPLAY 'Audit indicates success'
END-IF

* Evaluating action
EVALUATE TRUE
    WHEN AUD-CREATE
        PERFORM HANDLE-CREATE-AUDIT
    WHEN AUD-UPDATE
        PERFORM HANDLE-UPDATE-AUDIT
    WHEN AUD-DELETE
        PERFORM HANDLE-DELETE-AUDIT
END-EVALUATE
```

### Recording Before/After Images

```cobol
* Save before image
MOVE PORT-RECORD TO AUD-BEFORE-IMAGE

* Perform update
PERFORM UPDATE-PORTFOLIO

* Save after image
MOVE PORT-RECORD TO AUD-AFTER-IMAGE

* Build descriptive message
STRING 'Updated portfolio balance from '
       WS-OLD-BALANCE ' to ' WS-NEW-BALANCE
       DELIMITED BY SIZE
       INTO AUD-MESSAGE
```

## Programs Using This Copybook

### RPTAUD00 - Audit Report Generator

**Location**: `/src/programs/batch/RPTAUD00.cbl`

**Usage**: Reads audit records from an indexed AUDITLOG file to generate audit trail reports. Uses the copybook in the FILE SECTION to define the input record format.

```cobol
FD  AUDIT-FILE
    ASSIGN TO AUDITLOG
    ORGANIZATION IS INDEXED.
    COPY AUDITLOG.
```

**Key Operations**:
- Reads audit records sequentially
- Summarizes audit activity by type, action, and status
- Generates formatted audit reports

### AUDPROC - Audit Trail Processor

**Location**: `/src/programs/common/AUDPROC.cbl`

**Usage**: Callable subroutine that writes audit records to the audit file. Uses the copybook in the FILE SECTION for the output record.

```cobol
FD  AUDIT-FILE
    RECORDING MODE IS F
    BLOCK CONTAINS 0 RECORDS.
    COPY AUDITLOG.
```

**Key Operations**:
- Receives audit data via linkage section
- Timestamps each record
- Writes to sequential audit file
- Returns status to caller

### PORTTRAN - Portfolio Transaction Processing

**Location**: `/src/programs/portfolio/PORTTRAN.cbl`

**Usage**: Uses the copybook in WORKING-STORAGE to build audit records for transaction processing activities. Calls AUDPROC to write the records.

```cobol
WORKING-STORAGE SECTION.
    COPY ERRHAND.
    COPY AUDITLOG.
```

**Key Operations**:
- Creates audit records for buy, sell, transfer, and fee transactions
- Captures before images of portfolio state
- Maps transaction types to audit actions
- Calls AUDPROC to persist audit trail

## File Organization Options

The AUDITLOG copybook can be used with different file organizations:

### Sequential File (for AUDPROC)
```cobol
SELECT AUDIT-FILE
    ASSIGN TO AUDFILE
    ORGANIZATION IS SEQUENTIAL
    FILE STATUS IS WS-FILE-STATUS.
```
- Best for write-heavy workloads
- Simple append operations
- Good for batch processing

### Indexed File (for RPTAUD00)
```cobol
SELECT AUDIT-FILE
    ASSIGN TO AUDITLOG
    ORGANIZATION IS INDEXED
    ACCESS MODE IS DYNAMIC
    RECORD KEY IS AUD-TIMESTAMP
    FILE STATUS IS WS-FILE-STATUS.
```
- Enables random access by timestamp
- Good for queries and reporting
- Supports key-based retrieval

## Audit Type Guidelines

| Type | When to Use | Examples |
|------|-------------|----------|
| TRAN | Business transactions | Buy/sell securities, transfers, deposits |
| USER | User-initiated actions | Login, logout, password change, approvals |
| SYST | System events | Batch start/end, scheduled jobs, system errors |

## Action Code Guidelines

| Action | When to Use | Status Usually |
|--------|-------------|----------------|
| CREATE | New record inserted | SUCC or FAIL |
| UPDATE | Existing record modified | SUCC, FAIL, or WARN |
| DELETE | Record removed/deactivated | SUCC or FAIL |
| INQUIRE | Read-only access logged | SUCC |
| LOGIN | User authentication | SUCC or FAIL |
| LOGOUT | User session end | SUCC |
| STARTUP | Program/system initialization | SUCC or FAIL |
| SHUTDOWN | Program/system termination | SUCC or WARN |

## Compliance Considerations

The audit trail supports:
- **SOX Compliance**: Change tracking with before/after images
- **Access Monitoring**: User and terminal identification
- **Incident Investigation**: Timestamps and detailed messages
- **Data Integrity**: Success/failure status tracking

## Technical Notes

- **Record Size**: Total record length is 388 bytes
- **Timestamp Format**: Uses DB2-compatible timestamp format (26 bytes)
- **88-Level Conditions**: Enable readable code with SET and EVALUATE statements
- **Image Fields**: 100 bytes each - may need to truncate larger records
- **Trailing Spaces**: Action values are padded to 8 characters for consistent formatting
- **ACCEPT TIME STAMP**: Use `ACCEPT var FROM TIME STAMP` for proper timestamp format
- **FUNCTION CURRENT-DATE**: Alternative for timestamp, returns YYYYMMDDHHMMSSFF format
