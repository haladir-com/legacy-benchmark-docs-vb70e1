---
title: "SQLCA"
description: "SQL Communication Area - provides DB2 status information and common SQLSTATE code constants"
---

## Overview

SQLCA is a copybook that provides DB2 SQL communication area definitions and common SQLSTATE code constants. It includes the standard IBM SQLCA structure via `EXEC SQL INCLUDE SQLCA` and adds application-specific SQLSTATE constants for frequently checked conditions.

The SQL Communication Area (SQLCA) is automatically populated by DB2 after every SQL statement execution, providing return codes, diagnostic information, and row counts. This copybook extends the standard SQLCA with predefined constants for common SQLSTATE values, making error checking more readable and maintainable.

## Usage

```cobol
WORKING-STORAGE SECTION.
    COPY SQLCA.
```

Or within an SQL declare section:

```cobol
WORKING-STORAGE SECTION.
01  WS-DB2-AREA.
    EXEC SQL INCLUDE SQLCA END-EXEC.
    COPY SQLCA.
```

## Used By

| Program | Description |
|---------|-------------|
| [HISTLD00](/docs/programs/HISTLD00) | History Load Program |
| [DB2CMT](/docs/programs/DB2CMT) | DB2 Commit Handler |
| [DB2CONN](/docs/programs/DB2CONN) | DB2 Connection Manager |
| [DB2ERR](/docs/programs/DB2ERR) | DB2 Error Handler |
| [DB2STAT](/docs/programs/DB2STAT) | DB2 Statistics Collector |

## Data Structures

### Standard SQLCA (Included via EXEC SQL)

The `EXEC SQL INCLUDE SQLCA END-EXEC` statement includes the standard IBM SQLCA structure:

| Field | Type | Description |
|-------|------|-------------|
| SQLCAID | CHAR(8) | Eye-catcher 'SQLCA   ' |
| SQLCABC | INTEGER | SQLCA length in bytes (136) |
| SQLCODE | INTEGER | SQL return code |
| SQLERRML | SMALLINT | Length of SQLERRMC |
| SQLERRMC | VARCHAR(70) | Error message tokens |
| SQLERRP | CHAR(8) | Product ID |
| SQLERRD | INTEGER ARRAY(6) | Diagnostic information |
| SQLWARN | CHAR(11) | Warning flags |
| SQLSTATE | CHAR(5) | SQL state code |

#### SQLCA Structure Diagram

```
+----------+----------+----------+------------+----------+
| SQLCAID  | SQLCABC  | SQLCODE  | SQLERRML   | SQLERRMC |
| (8)      | (4)      | (4)      | (2)        | (70)     |
+----------+----------+----------+------------+----------+
| SQLERRP  | SQLERRD(1-6)        | SQLWARN    | SQLSTATE |
| (8)      | (24)                | (11)       | (5)      |
+----------+---------------------+------------+----------+
```

#### SQLCODE Values

| SQLCODE | Meaning |
|---------|---------|
| 0 | Successful execution |
| > 0 | Successful with warning |
| < 0 | Error occurred |
| +100 | No data found (end of cursor) |

#### SQLERRD Array

| Element | Description |
|---------|-------------|
| SQLERRD(1) | Reserved |
| SQLERRD(2) | Reserved |
| SQLERRD(3) | Number of rows affected (INSERT/UPDATE/DELETE) |
| SQLERRD(4) | Reserved |
| SQLERRD(5) | Position of error in SQL statement |
| SQLERRD(6) | Reserved |

#### SQLWARN Flags

| Flag | Meaning when 'W' |
|------|------------------|
| SQLWARN0 | At least one other warning flag is set |
| SQLWARN1 | String truncation occurred |
| SQLWARN2 | NULL values eliminated from function |
| SQLWARN3 | Number of columns > number of host variables |
| SQLWARN4 | UPDATE/DELETE without WHERE clause |
| SQLWARN5 | Reserved |
| SQLWARN6 | Date arithmetic resulted in end-of-month adjustment |
| SQLWARN7 | Reserved |
| SQLWARN8 | Character conversion resulted in substitution |
| SQLWARN9 | Reserved |
| SQLWARNA | Reserved |

### SQL-STATUS-CODES

Application-defined SQLSTATE constants for common conditions:

| Level | Name | Picture | Value | Description |
|-------|------|---------|-------|-------------|
| 01 | SQL-STATUS-CODES | - | - | SQLSTATE code constants |
| 05 | SQL-SUCCESS | X(5) | '00000' | Successful completion |
| 05 | SQL-NOT-FOUND | X(5) | '02000' | No data found |
| 05 | SQL-DUP-KEY | X(5) | '23505' | Unique constraint violation |
| 05 | SQL-DEADLOCK | X(5) | '40001' | Deadlock detected |
| 05 | SQL-TIMEOUT | X(5) | '40003' | Statement timeout |
| 05 | SQL-CONNECTION-ERROR | X(5) | '08001' | Connection failure |
| 05 | SQL-DB-ERROR | X(5) | '58004' | System error |

## SQLSTATE Classes

SQLSTATE is a 5-character code where the first 2 characters indicate the class:

| Class | Meaning | Examples |
|-------|---------|----------|
| 00 | Success | 00000 - Successful completion |
| 01 | Warning | 01xxx - Various warnings |
| 02 | No Data | 02000 - No rows found |
| 07 | Dynamic SQL Error | 07xxx - Invalid cursor state |
| 08 | Connection Exception | 08001 - Connection failure |
| 21 | Cardinality Violation | 21000 - Subquery returns multiple rows |
| 22 | Data Exception | 22xxx - Data errors |
| 23 | Constraint Violation | 23505 - Unique constraint |
| 24 | Invalid Cursor State | 24000 - Cursor not open |
| 40 | Transaction Rollback | 40001 - Deadlock |
| 42 | Syntax/Access Error | 42xxx - SQL syntax errors |
| 51 | Invalid Application State | 51xxx - Application errors |
| 57 | Resource Unavailable | 57xxx - Resource limits |
| 58 | System Error | 58004 - System failure |

## Usage Examples

### Basic SQLCODE Checking

```cobol
EXEC SQL
    SELECT CUST_NAME INTO :WS-CUST-NAME
    FROM CUSTOMER
    WHERE CUST_ID = :WS-CUST-ID
END-EXEC

EVALUATE SQLCODE
    WHEN 0
        CONTINUE
    WHEN +100
        MOVE 'Customer not found' TO ERR-TEXT
        PERFORM 9100-NOT-FOUND
    WHEN OTHER
        MOVE SQLCODE TO WS-SQLCODE-DISPLAY
        PERFORM 9000-DB2-ERROR
END-EVALUATE
```

### Using SQLSTATE Constants

```cobol
EXEC SQL
    INSERT INTO CUSTOMER VALUES
    (:WS-CUST-ID, :WS-CUST-NAME, :WS-CUST-ADDR)
END-EXEC

EVALUATE SQLSTATE
    WHEN SQL-SUCCESS
        ADD 1 TO WS-INSERT-COUNT
    WHEN SQL-DUP-KEY
        MOVE 'Duplicate customer ID' TO ERR-TEXT
        PERFORM 9200-DUPLICATE-ERROR
    WHEN SQL-DEADLOCK
        PERFORM 9300-RETRY-TRANSACTION
    WHEN OTHER
        PERFORM 9000-DB2-ERROR
END-EVALUATE
```

### Checking Rows Affected

```cobol
EXEC SQL
    UPDATE CUSTOMER
    SET CUST_STATUS = 'I'
    WHERE LAST_ACTIVITY < :WS-CUTOFF-DATE
END-EXEC

IF SQLCODE = 0
    MOVE SQLERRD(3) TO WS-ROWS-UPDATED
    DISPLAY 'Rows updated: ' WS-ROWS-UPDATED
END-IF
```

### Handling Warnings

```cobol
EXEC SQL
    SELECT LONG_DESCRIPTION INTO :WS-SHORT-DESC
    FROM PRODUCTS
    WHERE PRODUCT_ID = :WS-PRODUCT-ID
END-EXEC

IF SQLCODE = 0
    IF SQLWARN1 = 'W'
        DISPLAY 'Warning: Description was truncated'
    END-IF
END-IF
```

### Deadlock Retry Pattern

```cobol
MOVE 0 TO WS-RETRY-COUNT
MOVE 3 TO WS-MAX-RETRIES

PERFORM UNTIL WS-RETRY-COUNT >= WS-MAX-RETRIES
    OR SQLSTATE = SQL-SUCCESS
    
    EXEC SQL
        UPDATE INVENTORY
        SET QTY_ON_HAND = QTY_ON_HAND - :WS-QTY
        WHERE PRODUCT_ID = :WS-PRODUCT-ID
    END-EXEC
    
    EVALUATE SQLSTATE
        WHEN SQL-SUCCESS
            CONTINUE
        WHEN SQL-DEADLOCK
            ADD 1 TO WS-RETRY-COUNT
            EXEC SQL ROLLBACK END-EXEC
            CALL 'DELAY' USING WS-RETRY-DELAY
        WHEN OTHER
            MOVE WS-MAX-RETRIES TO WS-RETRY-COUNT
            PERFORM 9000-DB2-ERROR
    END-EVALUATE
END-PERFORM
```

## Common SQLCODE Reference

### Successful/Warning Codes

| SQLCODE | SQLSTATE | Description |
|---------|----------|-------------|
| 0 | 00000 | Successful execution |
| +100 | 02000 | No data found / End of cursor |
| +304 | 01515 | Value not within host variable range |
| +802 | 01519 | Null value or data exception |

### Error Codes

| SQLCODE | SQLSTATE | Description |
|---------|----------|-------------|
| -104 | 42601 | Invalid SQL statement |
| -117 | 42802 | Number of values doesn't match columns |
| -180 | 22007 | Invalid date/time value |
| -181 | 22007 | Invalid date/time value |
| -204 | 42704 | Object not defined |
| -206 | 42703 | Column not found |
| -305 | 22002 | Null indicator needed |
| -407 | 23502 | NOT NULL constraint violation |
| -530 | 23503 | Foreign key constraint violation |
| -532 | 23504 | Delete restricted by foreign key |
| -545 | 23513 | Check constraint violation |
| -803 | 23505 | Duplicate key violation |
| -811 | 21000 | Subquery returns multiple rows |
| -904 | 57011 | Resource unavailable |
| -911 | 40001 | Deadlock or timeout |
| -913 | 40001 | Deadlock detected |

## Related Copybooks

| Copybook | Relationship |
|----------|-------------|
| **DBPROC** | DB2 standard procedures including error handling |
| **DBTBLS** | DB2 table declarations |
| **ERRHAND** | General error handling (works with SQLCA for DB2 errors) |

## Design Notes

1. **Dual Include**: This copybook uses `EXEC SQL INCLUDE SQLCA` to get the standard IBM structure, then adds application-specific constants.

2. **SQLSTATE vs SQLCODE**: SQLSTATE is the SQL standard (portable across databases), while SQLCODE is IBM-specific. Both are provided by DB2.

3. **5-Character SQLSTATE**: The constants use `PIC X(5)` to match SQLSTATE's fixed 5-character format.

4. **Common Conditions**: Only the most frequently checked SQLSTATE values are defined as constants to keep the copybook focused.

5. **Thread Safety**: SQLCA is automatically managed per thread/connection, no special handling needed.

## Best Practices

1. **Always Check SQLCODE**: Check after every SQL statement, not just SELECT.

2. **Use SQLSTATE for Portability**: When possible, check SQLSTATE rather than SQLCODE for database-independent code.

3. **Save Before Calling**: Save SQLCODE/SQLSTATE before calling other routines that might execute SQL.

4. **Check SQLERRD(3)**: After INSERT/UPDATE/DELETE, verify expected row count.

5. **Handle Deadlocks**: Implement retry logic for `-911`/`-913` (SQLSTATE '40001').

6. **Log Complete Context**: When logging errors, include SQLCODE, SQLSTATE, and SQLERRMC.
