---
title: "DBPROC"
description: "DB2 Standard Procedures - provides reusable DB2 error handling structures and common database procedures"
---

## Overview

DBPROC is a copybook that provides standardized DB2 database procedures and error handling structures for COBOL programs. It contains both data definitions for error tracking and executable procedure paragraphs that can be performed by including programs.

The copybook serves as a foundation for DB2 operations by providing:
- **Error message formatting**: Structured area for capturing SQLCODE, SQLSTATE, and error text
- **Retry logic support**: Configurable retry counters and wait times for transient failures
- **Standard procedures**: Reusable paragraphs for connection, disconnection, and error handling

:::note Executable Code
Unlike most copybooks that contain only data definitions, DBPROC includes executable PROCEDURE DIVISION paragraphs. These paragraphs are copied into the including program and can be PERFORMed directly.
:::

## Data Structures

### DB2 Error Handling (DB2-ERROR-HANDLING)

Complete structure for capturing and formatting DB2 errors:

| Level | Name | Picture | Value | Description |
|-------|------|---------|-------|-------------|
| 01 | DB2-ERROR-HANDLING | Group | | Error handling work area |
| 05 | DB2-ERROR-MESSAGE | Group | | Formatted error message (107 bytes) |
| 10 | FILLER | X(9) | 'SQLCODE: ' | Message prefix |
| 10 | DB2-SQLCODE-TXT | X(6) | | SQLCODE as text |
| 10 | FILLER | X(9) | ' STATE: ' | State label |
| 10 | DB2-STATE | X(5) | | SQLSTATE value |
| 10 | FILLER | X(8) | ' ERROR: ' | Error label |
| 10 | DB2-ERROR-TEXT | X(70) | | Error description text |
| 05 | DB2-SAVE-STATUS | X(5) | | Saved SQLSTATE for recovery |
| 05 | DB2-RETRY-COUNT | S9(4) COMP | 0 | Current retry attempt |
| 05 | DB2-MAX-RETRIES | S9(4) COMP | 3 | Maximum retry attempts |
| 05 | DB2-RETRY-WAIT | S9(4) COMP | 100 | Wait time between retries (centiseconds) |

### Error Message Format

The `DB2-ERROR-MESSAGE` field produces a formatted string like:

```
SQLCODE: -803   STATE: 23505 ERROR: Duplicate key violation on INSERT
```

This format provides:
- Quick identification of the SQL error code
- SQL state for standardized error classification
- Human-readable error description

## Procedures

### CONNECT-TO-DB2

Establishes a connection to the DB2 database.

```cobol
CONNECT-TO-DB2.
    EXEC SQL
        CONNECT TO POSMVP
    END-EXEC
    IF SQLCODE NOT = 0
        MOVE 'Connection failed' TO DB2-ERROR-TEXT
        PERFORM DB2-ERROR-ROUTINE
    END-IF
    .
```

**Behavior:**
- Connects to the POSMVP database (hardcoded)
- On failure, sets error text and invokes error routine
- Should be performed during program initialization

**Prerequisites:**
- SQLCA must be included
- ERRHAND copybook must be included (for ERR-PROGRAM, ERR-TEXT)

### DISCONNECT-FROM-DB2

Gracefully disconnects from the DB2 database.

```cobol
DISCONNECT-FROM-DB2.
    EXEC SQL
        COMMIT WORK
    END-EXEC
    
    EXEC SQL
        CONNECT RESET
    END-EXEC
    .
```

**Behavior:**
- Commits any pending work before disconnecting
- Releases the database connection
- Should be performed during program termination

**Note:** This procedure does not check SQLCODE after execution. Calling programs should check SQLCODE if error detection is needed.

### DB2-ERROR-ROUTINE

Central error handling procedure for DB2 failures.

```cobol
DB2-ERROR-ROUTINE.
    MOVE SQLCODE TO DB2-SQLCODE-TXT
    MOVE SQLSTATE TO DB2-STATE
    
    EXEC SQL
        ROLLBACK WORK
    END-EXEC
    
    MOVE 'DB2ERROR' TO ERR-PROGRAM
    MOVE DB2-ERROR-MESSAGE TO ERR-TEXT
    CALL 'ERRPROC' USING ERR-MESSAGE
    .
```

**Behavior:**
1. Captures SQLCODE and SQLSTATE into error message structure
2. Rolls back the current unit of work
3. Sets program identifier to 'DB2ERROR'
4. Copies formatted error message to ERR-TEXT
5. Calls ERRPROC for centralized error logging

**Prerequisites:**
- SQLCA must be included
- ERRHAND copybook must be included
- ERRPROC program must be available in the load library

### CHECK-SQL-STATUS

Simple SQLCODE checker that invokes error routine on failure.

```cobol
CHECK-SQL-STATUS.
    IF SQLCODE NOT = 0
        PERFORM DB2-ERROR-ROUTINE
    END-IF
    .
```

**Usage:**
```cobol
EXEC SQL
    INSERT INTO PORTFOLIO ...
END-EXEC
PERFORM CHECK-SQL-STATUS
```

**Note:** This procedure treats any non-zero SQLCODE as an error, including warning codes (+100, etc.). For more granular handling, check SQLCODE directly.

## Usage

### Including the Copybook

```cobol
WORKING-STORAGE SECTION.
    EXEC SQL INCLUDE SQLCA END-EXEC.
    COPY DBPROC.
    COPY ERRHAND.
```

**Important:** DBPROC must be included after SQLCA (for SQLCODE/SQLSTATE) and requires ERRHAND (for ERR-PROGRAM, ERR-TEXT, ERR-MESSAGE).

### Basic Usage Pattern

```cobol
PROCEDURE DIVISION.
0000-MAIN.
    PERFORM CONNECT-TO-DB2
    
    PERFORM PROCESS-DATA
    
    PERFORM DISCONNECT-FROM-DB2
    GOBACK
    .

PROCESS-DATA.
    EXEC SQL
        SELECT * FROM PORTFOLIO
        WHERE PORTFOLIO_ID = :WS-PORT-ID
    END-EXEC
    
    PERFORM CHECK-SQL-STATUS
    .
```

### Using Retry Logic

```cobol
PERFORM-WITH-RETRY.
    MOVE 0 TO DB2-RETRY-COUNT
    
    PERFORM UNTIL DB2-RETRY-COUNT >= DB2-MAX-RETRIES
        EXEC SQL
            UPDATE PORTFOLIO SET ...
        END-EXEC
        
        IF SQLCODE = 0
            EXIT PERFORM
        END-IF
        
        IF SQLCODE = -911 OR SQLCODE = -913
            *> Deadlock or timeout - retry
            ADD 1 TO DB2-RETRY-COUNT
            CALL 'DELAY' USING DB2-RETRY-WAIT
        ELSE
            *> Other error - don't retry
            PERFORM DB2-ERROR-ROUTINE
            EXIT PERFORM
        END-IF
    END-PERFORM
    .
```

### Custom Error Handling

```cobol
CUSTOM-INSERT.
    EXEC SQL
        INSERT INTO PORTFOLIO VALUES (...)
    END-EXEC
    
    EVALUATE SQLCODE
        WHEN 0
            CONTINUE
        WHEN -803
            *> Duplicate key - handle specifically
            MOVE 'Portfolio already exists' TO DB2-ERROR-TEXT
            PERFORM DB2-ERROR-ROUTINE
        WHEN OTHER
            *> All other errors
            MOVE 'Insert failed' TO DB2-ERROR-TEXT
            PERFORM DB2-ERROR-ROUTINE
    END-EVALUATE
    .
```

## Programs Using This Copybook

| Program | Purpose | Usage |
|---------|---------|-------|
| HISTLD00 | History Data Loader | Uses error handling and retry logic for batch loading |
| DB2CMT | DB2 Commit Controller | Uses error structures for commit/rollback tracking |
| DB2CONN | DB2 Connection Manager | Uses connection procedures and error handling |
| DB2ERR | DB2 Error Handler | Uses error message formatting and severity classification |
| DB2STAT | DB2 Statistics Collector | Uses error handling for statistics operations |

## Related Copybooks

| Copybook | Relationship |
|----------|--------------|
| SQLCA | **Required** - Provides SQLCODE, SQLSTATE, SQLERRMC used by DBPROC procedures |
| ERRHAND | **Required** - Provides ERR-PROGRAM, ERR-TEXT, ERR-MESSAGE used by DB2-ERROR-ROUTINE |
| DBTBLS | Optional - DB2 table definitions that may be used alongside DBPROC |

## Design Notes

### Hardcoded Database Name

The `CONNECT-TO-DB2` procedure connects to 'POSMVP' by default. To connect to a different database:

1. **Option 1**: Modify the copybook for your environment
2. **Option 2**: Don't use `CONNECT-TO-DB2`; write custom connection logic
3. **Option 3**: Use DB2CONN program which accepts database name as parameter

### Automatic Rollback

The `DB2-ERROR-ROUTINE` automatically performs a ROLLBACK before logging. This ensures:
- Database consistency after errors
- Clean state before potential retry
- No orphaned locks

If you need to preserve uncommitted work, check SQLCODE and handle errors without calling `DB2-ERROR-ROUTINE`.

### Retry Configuration

Default retry settings:
- **DB2-MAX-RETRIES**: 3 attempts
- **DB2-RETRY-WAIT**: 100 centiseconds (1 second)

These can be modified at runtime:
```cobol
MOVE 5 TO DB2-MAX-RETRIES      *> Increase to 5 attempts
MOVE 200 TO DB2-RETRY-WAIT     *> Increase wait to 2 seconds
```

### Error Message Size

The `DB2-ERROR-TEXT` field is 70 characters. Longer error descriptions will be truncated. For detailed error information, use the SQLERRMC field from SQLCA or call DB2ERR for comprehensive diagnostics.

### Thread Safety

The working storage fields in DBPROC are not thread-safe. In CICS or multi-threaded environments, each thread should have its own copy of the working storage, which COBOL provides automatically through separate working storage instances.
