---
title: "CKPRST"
description: "Checkpoint/Restart Control Structure - Copybook defining data structures for batch program checkpoint and restart capabilities"
---

## Overview

CKPRST is a copybook that defines the data structures required for implementing checkpoint/restart functionality in batch COBOL programs. It provides a standardized framework for capturing program state, tracking processing progress, and enabling recovery from failures without reprocessing already-completed work.

The copybook contains two main record structures:
- **CHECKPOINT-CONTROL** - Working storage structure for managing checkpoint state during program execution
- **CHECKPOINT-RECORD** - VSAM file record layout for persisting checkpoint data

Checkpoint/restart is essential for long-running batch programs, providing:
- **Recoverability** - Resume processing from the last successful checkpoint after a failure
- **Restartability** - Rerun jobs without duplicate processing
- **Auditability** - Track processing statistics and program phases

## Data Structures

### CHECKPOINT-CONTROL (01 Level)

The main working storage structure for checkpoint management:

```
01  CHECKPOINT-CONTROL.
    05  CK-HEADER.
    05  CK-COUNTERS.
    05  CK-POSITION.
    05  CK-RESOURCES.
    05  CK-CONTROL-INFO.
```

### CK-HEADER - Checkpoint Header

| Level | Name | Picture | Description |
|-------|------|---------|-------------|
| 05 | CK-HEADER | | Header information group |
| 10 | CK-PROGRAM-ID | X(8) | Program identifier |
| 10 | CK-RUN-DATE | X(8) | Run date (YYYYMMDD) |
| 10 | CK-RUN-TIME | X(6) | Run time (HHMMSS) |
| 10 | CK-STATUS | X(1) | Processing status |

#### CK-STATUS Values

| Value | 88-Level Name | Description |
|-------|---------------|-------------|
| I | CK-INITIAL | Initial state - processing not started |
| A | CK-ACTIVE | Active - processing in progress |
| C | CK-COMPLETE | Complete - processing finished successfully |
| F | CK-FAILED | Failed - processing terminated with error |
| R | CK-RESTARTED | Restarted - resumed from checkpoint |

### CK-COUNTERS - Processing Counters

| Level | Name | Picture | Description |
|-------|------|---------|-------------|
| 05 | CK-COUNTERS | | Counter group |
| 10 | CK-RECORDS-READ | 9(9) COMP | Total records read |
| 10 | CK-RECORDS-PROC | 9(9) COMP | Records successfully processed |
| 10 | CK-RECORDS-ERROR | 9(9) COMP | Records with errors |
| 10 | CK-RESTART-COUNT | 9(2) COMP | Number of restart attempts |

### CK-POSITION - Processing Position

| Level | Name | Picture | Description |
|-------|------|---------|-------------|
| 05 | CK-POSITION | | Position tracking group |
| 10 | CK-LAST-KEY | X(50) | Last successfully processed record key |
| 10 | CK-LAST-TIME | X(26) | Timestamp of last checkpoint |
| 10 | CK-PHASE | X(2) | Current processing phase |

#### CK-PHASE Values

| Value | 88-Level Name | Description |
|-------|---------------|-------------|
| 00 | CK-PHASE-INIT | Initialization phase |
| 10 | CK-PHASE-READ | Reading/input phase |
| 20 | CK-PHASE-PROC | Processing phase |
| 30 | CK-PHASE-UPDT | Update/output phase |
| 40 | CK-PHASE-TERM | Termination phase |

### CK-RESOURCES - File Resource Tracking

| Level | Name | Picture | Occurs | Description |
|-------|------|---------|--------|-------------|
| 05 | CK-RESOURCES | | | Resource tracking group |
| 10 | CK-FILE-STATUS | | 5 | File status array (5 files max) |
| 15 | CK-FILE-NAME | X(8) | | File logical name |
| 15 | CK-FILE-POS | X(50) | | File position/key |
| 15 | CK-FILE-STATUS | X(2) | | VSAM file status |

### CK-CONTROL-INFO - Control Parameters

| Level | Name | Picture | Default | Description |
|-------|------|---------|---------|-------------|
| 05 | CK-CONTROL-INFO | | | Control parameters group |
| 10 | CK-COMMIT-FREQ | 9(5) COMP | 1000 | Records between commits |
| 10 | CK-MAX-ERRORS | 9(3) COMP | 100 | Maximum errors before abort |
| 10 | CK-MAX-RESTARTS | 9(2) COMP | 3 | Maximum restart attempts |
| 10 | CK-RESTART-MODE | X(1) | | Current restart mode |

#### CK-RESTART-MODE Values

| Value | 88-Level Name | Description |
|-------|---------------|-------------|
| N | CK-MODE-NORMAL | Normal processing (no restart) |
| R | CK-MODE-RESTART | Restart from last checkpoint |
| C | CK-MODE-RECOVER | Recovery mode (special handling) |

### CHECKPOINT-RECORD (01 Level)

The VSAM file record structure for persisting checkpoints:

| Level | Name | Picture | Description |
|-------|------|---------|-------------|
| 01 | CHECKPOINT-RECORD | | VSAM checkpoint record |
| 05 | CKR-KEY | | Composite key |
| 10 | CKR-PROGRAM-ID | X(8) | Program identifier |
| 10 | CKR-RUN-DATE | X(8) | Run date (YYYYMMDD) |
| 05 | CKR-DATA | X(400) | Checkpoint data area |

## Standard Processing Routines

The copybook documents standard checkpoint processing routines that should be called via external programs:

| Routine | Program | Purpose |
|---------|---------|---------|
| PROC-CHECKPOINT-INIT | CKPINIT | Initialize checkpoint processing |
| PROC-CHECKPOINT-TAKE | CKPTAKE | Take a checkpoint |
| PROC-CHECKPOINT-COMMIT | CKPCMIT | Commit checkpoint to VSAM |
| PROC-CHECKPOINT-RESTART | CKPRSTR | Restart from checkpoint |

### Example Calls

```cobol
* Initialize checkpoint processing
CALL 'CKPINIT' USING CHECKPOINT-CONTROL
                     RETURN-STATUS

* Take a checkpoint
CALL 'CKPTAKE' USING CHECKPOINT-CONTROL
                     RETURN-STATUS

* Commit checkpoint to permanent storage
CALL 'CKPCMIT' USING CHECKPOINT-CONTROL
                     RETURN-STATUS

* Restart from last checkpoint
CALL 'CKPRSTR' USING CHECKPOINT-CONTROL
                     RETURN-STATUS
```

## Usage Pattern

### Typical Batch Program Flow

```cobol
WORKING-STORAGE SECTION.
    COPY CKPRST.

PROCEDURE DIVISION.
0000-MAIN.
    * Initialize checkpoint
    SET CK-INITIAL TO TRUE
    MOVE 'MYPROG01' TO CK-PROGRAM-ID
    ACCEPT CK-RUN-DATE FROM DATE YYYYMMDD
    CALL 'CKPINIT' USING CHECKPOINT-CONTROL
                         RETURN-STATUS

    * Check for restart
    IF CK-MODE-RESTART
        CALL 'CKPRSTR' USING CHECKPOINT-CONTROL
                             RETURN-STATUS
        * Position files to last checkpoint
    END-IF

    * Process records
    PERFORM UNTIL END-OF-FILE
        READ input-file
        ADD 1 TO CK-RECORDS-READ
        
        PERFORM process-record
        ADD 1 TO CK-RECORDS-PROC
        
        * Take checkpoint at intervals
        IF CK-RECORDS-PROC >= CK-COMMIT-FREQ
            MOVE current-key TO CK-LAST-KEY
            CALL 'CKPTAKE' USING CHECKPOINT-CONTROL
                                 RETURN-STATUS
            CALL 'CKPCMIT' USING CHECKPOINT-CONTROL
                                 RETURN-STATUS
        END-IF
    END-PERFORM

    * Final checkpoint
    SET CK-COMPLETE TO TRUE
    CALL 'CKPCMIT' USING CHECKPOINT-CONTROL
                         RETURN-STATUS
    .
```

## Programs Using This Copybook

| Program | Description |
|---------|-------------|
| CKPRST | Checkpoint/Restart processing program |

## Related Copybooks

| Copybook | Relationship |
|----------|--------------|
| RETHND | Return handling definitions - used with CKPRST for return status |
| BCHCTL | Batch control - higher-level job sequencing (complements CKPRST) |

## Technical Notes

### VSAM Checkpoint File

The checkpoint file should be defined as a VSAM KSDS with:
- Primary key: CKR-PROGRAM-ID + CKR-RUN-DATE (16 bytes)
- Record length: 416 bytes (16 key + 400 data)
- One record per program per run date

### Commit Frequency

The default `CK-COMMIT-FREQ` of 1000 records balances:
- **Performance**: Fewer checkpoints = less I/O overhead
- **Recovery**: More frequent checkpoints = less reprocessing on restart

Adjust based on:
- Processing time per record
- Acceptable reprocessing time after failure
- Transaction/commit overhead

### Multi-File Processing

The `CK-RESOURCES` array supports tracking up to 5 files simultaneously. For each file:
- Store the logical name in `CK-FILE-NAME`
- Store the current position/key in `CK-FILE-POS`
- Store the last file status in `CK-FILE-STATUS`

On restart, use this information to reposition all files.

### Phase Tracking

The `CK-PHASE` field enables phase-specific restart logic:
- `00` (INIT): Restart from beginning
- `10` (READ): Reposition input files
- `20` (PROC): Resume processing
- `30` (UPDT): Resume output operations
- `40` (TERM): Skip to termination

### Error Threshold

The `CK-MAX-ERRORS` default of 100 allows some error tolerance while preventing runaway processing. When `CK-RECORDS-ERROR` exceeds this value, the program should:
1. Take a final checkpoint
2. Set `CK-FAILED` status
3. Terminate gracefully

### Restart Counter

The `CK-RESTART-COUNT` tracks restart attempts. Programs should check against `CK-MAX-RESTARTS` (default 3) to prevent infinite restart loops on persistent errors.

### Timestamp Format

The `CK-LAST-TIME` field uses a 26-character ISO timestamp format:
```
YYYY-MM-DD-HH.MM.SS.FFFFFF
```
This provides millisecond precision for audit and debugging purposes.
