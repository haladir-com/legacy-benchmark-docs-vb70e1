---
title: "SQLCA"
description: "SQL Communication Area copybook providing DB2 status handling with the standard SQLCA structure and application-defined SQLSTATE codes"
---

## Overview

SQLCA is a DB2-specific copybook that provides the SQL Communication Area for programs that interact with DB2 databases. It combines the standard IBM-provided SQLCA structure (included via `EXEC SQL INCLUDE SQLCA`) with application-defined SQLSTATE codes for common database conditions.

The SQL Communication Area is fundamental to DB2 programmingâ€”it receives status information after every SQL statement execution, enabling programs to detect and respond to success, warnings, and errors. This copybook extends the standard SQLCA with pre-defined constants for frequently encountered SQLSTATE values, making status checking more readable and maintainable.

This copybook is used by all programs that perform DB2 database operations, including batch loaders, commit controllers, connection managers, and error handlers.

## Data Structures

### Standard SQLCA (IBM-Provided)

The `EXEC SQL INCLUDE SQLCA END-EXEC` directive includes the standard IBM SQLCA structure. The key fields are:

| Field | Type | Description |
|-------|------|-------------|
| SQLCODE | S9(9) COMP | Primary return code from DB2 |
| SQLERRM | VARCHAR(70) | Error message text |
| SQLERRP | CHAR(8) | Product signature (e.g., 'DSN') |
| SQLERRD | ARRAY(6) OF S9(9) COMP | Diagnostic information array |
| SQLWARN | CHAR(11) | Warning flags |
| SQLSTATE | CHAR(5) | SQL standard state code |

#### SQLCODE Values

| Value | Meaning |
|-------|---------|
| 0 | Successful execution |
| > 0 | Success with warning |
| 100 | No data found (end of cursor) |
| < 0 | Error occurred |

#### Common Negative SQLCODEs

| SQLCODE | Description |
|---------|-------------|
| -803 | Duplicate key on insert |
| -805 | Package not found |
| -811 | Multiple rows returned for SELECT INTO |
| -818 | Timestamp mismatch |
| -904 | Resource unavailable |
| -911 | Deadlock or timeout |
| -913 | Deadlock detected |

### Application-Defined SQLSTATE Codes (SQL-STATUS-CODES)

Pre-defined constants for common SQLSTATE values:

| Level | Name | Picture | Value | Description |
|-------|------|---------|-------|-------------|
| 01 | SQL-STATUS-CODES | - | - | SQLSTATE constants group |
| 05 | SQL-SUCCESS | X(5) | '00000' | Successful completion |
| 05 | SQL-NOT-FOUND | X(5) | '02000' | No data found |
| 05 | SQL-DUP-KEY | X(5) | '23505' | Unique constraint violation |
| 05 | SQL-DEADLOCK | X(5) | '40001' | Serialization failure (deadlock) |
| 05 | SQL-TIMEOUT | X(5) | '40003' | Statement completion unknown (timeout) |
| 05 | SQL-CONNECTION-ERROR | X(5) | '08001' | Connection exception |
| 05 | SQL-DB-ERROR | X(5) | '58004' | System error |

## SQLSTATE Class Codes

SQLSTATE is a 5-character code where the first 2 characters indicate the class:

| Class | Meaning |
|-------|---------|
| 00 | Success |
| 01 | Warning |
| 02 | No data |
| 07 | Dynamic SQL error |
| 08 | Connection exception |
| 21 | Cardinality violation |
| 22 | Data exception |
| 23 | Constraint violation |
| 24 | Invalid cursor state |
| 25 | Invalid transaction state |
| 26 | Invalid SQL statement identifier |
| 40 | Transaction rollback |
| 42 | Syntax error or access violation |
| 44 | WITH CHECK OPTION violation |
| 51 | Invalid application state |
| 54 | SQL or product limit exceeded |
| 55 | Object not in prerequisite state |
| 56 | Miscellaneous SQL or product error |
| 57 | Resource not available |
| 58 | System error |

## Usage Examples

### Basic SQL Status Checking

```cobol
WORKING-STORAGE SECTION.
    COPY SQLCA.

PROCEDURE DIVISION.
    EXEC SQL
        SELECT COL1, COL2 
        INTO :WS-COL1, :WS-COL2
        FROM MYTABLE
        WHERE KEY = :WS-KEY
    END-EXEC
    
    EVALUATE TRUE
        WHEN SQLCODE = 0
            CONTINUE
        WHEN SQLCODE = 100
            MOVE 'Record not found' TO WS-MESSAGE
        WHEN SQLCODE = -803
            MOVE 'Duplicate key' TO WS-MESSAGE
        WHEN OTHER
            PERFORM 9000-SQL-ERROR
    END-EVALUATE
```

### Using SQLSTATE Constants

```cobol
    EXEC SQL
        INSERT INTO MYTABLE VALUES (:WS-RECORD)
    END-EXEC
    
    EVALUATE SQLSTATE
        WHEN SQL-SUCCESS
            ADD 1 TO WS-INSERT-COUNT
        WHEN SQL-DUP-KEY
            MOVE 'Duplicate record - skipping' TO WS-MESSAGE
            ADD 1 TO WS-DUP-COUNT
        WHEN SQL-DEADLOCK
            PERFORM 9100-HANDLE-DEADLOCK
        WHEN OTHER
            PERFORM 9000-SQL-ERROR
    END-EVALUATE
```

### Error Logging with SQLCA Fields

```cobol
9000-SQL-ERROR.
    DISPLAY 'SQL Error occurred'
    DISPLAY '  SQLCODE:  ' SQLCODE
    DISPLAY '  SQLSTATE: ' SQLSTATE
    DISPLAY '  SQLERRMC: ' SQLERRMC
    
    MOVE SQLCODE TO WS-ERROR-SQLCODE
    MOVE SQLSTATE TO WS-ERROR-SQLSTATE
    MOVE SQLERRMC TO WS-ERROR-MESSAGE
    
    PERFORM 9500-WRITE-ERROR-LOG
    .
```

### Deadlock Retry Logic

```cobol
2000-INSERT-WITH-RETRY.
    MOVE 0 TO WS-RETRY-COUNT
    MOVE 'N' TO WS-SUCCESS-FLAG
    
    PERFORM UNTIL WS-SUCCESS-FLAG = 'Y'
                  OR WS-RETRY-COUNT > 3
        EXEC SQL
            INSERT INTO MYTABLE VALUES (:WS-RECORD)
        END-EXEC
        
        EVALUATE SQLSTATE
            WHEN SQL-SUCCESS
                MOVE 'Y' TO WS-SUCCESS-FLAG
            WHEN SQL-DEADLOCK
                ADD 1 TO WS-RETRY-COUNT
                IF WS-RETRY-COUNT <= 3
                    EXEC SQL ROLLBACK END-EXEC
                    CALL 'DELAY' USING WS-WAIT-TIME
                END-IF
            WHEN OTHER
                PERFORM 9000-SQL-ERROR
                MOVE 'Y' TO WS-SUCCESS-FLAG
        END-EVALUATE
    END-PERFORM
    .
```

### Cursor Processing with Status Check

```cobol
2100-FETCH-LOOP.
    PERFORM UNTIL SQLSTATE = SQL-NOT-FOUND
        EXEC SQL
            FETCH MYCURSOR INTO :WS-ROW
        END-EXEC
        
        IF SQLSTATE = SQL-SUCCESS
            ADD 1 TO WS-FETCH-COUNT
            PERFORM 2200-PROCESS-ROW
        ELSE
            IF SQLSTATE NOT = SQL-NOT-FOUND
                PERFORM 9000-SQL-ERROR
            END-IF
        END-IF
    END-PERFORM
    .
```

## Programs Using This Copybook

SQLCA is used by 5 programs that perform DB2 operations:

| Program | Description |
|---------|-------------|
| HISTLD00 | Position history DB2 loader - bulk inserts into POSHIST table |
| DB2CMT | DB2 commit controller - manages commits, rollbacks, savepoints |
| DB2CONN | DB2 connection manager - handles database connections |
| DB2ERR | DB2 error handler - processes and logs SQL errors |
| DB2STAT | DB2 status checker - validates connection and statement status |

## Related Copybooks

| Copybook | Relationship |
|----------|--------------|
| DBPROC | DB2 procedures - standard routines that use SQLCA |
| DBTBLS | DB2 table definitions - host variable structures |
| ERRHAND | Error handling - complements SQLCA for error reporting |

## Technical Notes

### SQLCA vs SQLSTATE

DB2 provides two mechanisms for status checking:

| Aspect | SQLCODE | SQLSTATE |
|--------|---------|----------|
| Format | Signed integer | 5-character string |
| Standard | IBM-specific | SQL standard (ISO/ANSI) |
| Granularity | Very specific | Class-based categories |
| Portability | DB2 only | Cross-platform |
| Recommendation | Legacy code | New development |

**Best Practice**: Use SQLSTATE for new code as it's more portable and follows SQL standards.

### SQLERRD Array

The SQLERRD array contains diagnostic information:

| Element | Content |
|---------|---------|
| SQLERRD(1) | Internal use |
| SQLERRD(2) | Internal use |
| SQLERRD(3) | Number of rows affected by INSERT/UPDATE/DELETE |
| SQLERRD(4) | Relative cost estimate for PREPARE |
| SQLERRD(5) | Position of error in SQL statement |
| SQLERRD(6) | Internal use |

### SQLWARN Flags

The SQLWARN field contains warning indicators:

| Flag | Meaning |
|------|---------|
| SQLWARN0 | Set if any other warning flag is set |
| SQLWARN1 | String truncation occurred |
| SQLWARN2 | Null values eliminated from function |
| SQLWARN3 | Number of columns exceeds host variables |
| SQLWARN4 | UPDATE/DELETE without WHERE clause |
| SQLWARN5 | SQL statement is not valid |
| SQLWARN6 | Date arithmetic adjustment |
| SQLWARN7 | Character conversion adjustment |

### Connection Error Handling

For connection errors (SQLSTATE '08xxx'), the application should:

1. Log the error details
2. Attempt reconnection (with limits)
3. If reconnection fails, terminate gracefully
4. Notify operations/monitoring systems

```cobol
IF SQLSTATE(1:2) = '08'
    PERFORM 9200-CONNECTION-ERROR
END-IF
```

### Performance Considerations

1. **Check SQLCODE first**: It's a simple integer comparison
2. **Use SQLSTATE for categorization**: When you need to handle classes of errors
3. **Minimize SQLERRMC access**: String handling is slower than numeric comparison
4. **Cache status locally**: Copy SQLCODE/SQLSTATE before additional SQL operations

### Precompiler Requirements

The `EXEC SQL INCLUDE SQLCA END-EXEC` statement requires:
- DB2 precompiler processing before COBOL compilation
- Proper precompiler options (e.g., `SQL('HOST(COB2)')`)
- Access to DB2 DCLGEN/INCLUDE libraries

### JCL Considerations

When compiling programs using SQLCA:

```jcl
//PRECOMP  EXEC PGM=DSNHPC,PARM='HOST(COB2),SQL(DB2)'
//DBRMLIB  DD  DSN=your.dbrm.library,DISP=SHR
//SYSLIB   DD  DSN=your.copybook.library,DISP=SHR
//SYSCIN   DD  DSN=&&TEMP,DISP=(NEW,PASS)
//SYSPRINT DD  SYSOUT=*
//SYSIN    DD  DSN=your.source.library(PROGRAM),DISP=SHR
```
