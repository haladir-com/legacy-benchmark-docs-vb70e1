---
title: "DBTBLS"
description: "DB2 table definitions copybook providing COBOL host variable structures for position history and error log tables"
---

## Overview

DBTBLS (DB2 Tables) is a copybook that defines COBOL host variable structures corresponding to DB2 database tables. It provides the record layouts needed for programs to interact with the Position History table (POSHIST) and the Error Log table (ERRLOG) via embedded SQL statements.

These structures serve as the COBOL representation of DB2 table rows, enabling programs to INSERT, SELECT, UPDATE, and DELETE data while maintaining proper data type alignment between COBOL and DB2.

## Data Structures

### Structure Overview

```
01  POSHIST-RECORD           - Position/Transaction History
    05  PH-*                  - Transaction details, amounts, audit info

01  ERRLOG-RECORD            - Application Error Log
    05  EL-*                  - Error details, severity, messages
```

## Position History Table (POSHIST-RECORD)

The POSHIST-RECORD structure maps to the Position History table, which stores all portfolio transaction history including buys, sells, and other movements.

### Field Definitions

#### Key Fields

| Field | Picture | DB2 Type | Description |
|-------|---------|----------|-------------|
| PH-ACCOUNT-NO | X(8) | CHAR(8) | Account number |
| PH-PORTFOLIO-ID | X(10) | CHAR(10) | Portfolio identifier |
| PH-TRANS-DATE | X(10) | DATE | Transaction date (YYYY-MM-DD) |
| PH-TRANS-TIME | X(8) | TIME | Transaction time (HH:MM:SS) |

#### Transaction Details

| Field | Picture | DB2 Type | Description |
|-------|---------|----------|-------------|
| PH-TRANS-TYPE | X(2) | CHAR(2) | Transaction type code |
| PH-SECURITY-ID | X(12) | CHAR(12) | Security/instrument identifier |
| PH-QUANTITY | S9(12)V9(3) COMP-3 | DECIMAL(15,3) | Number of units/shares |
| PH-PRICE | S9(12)V9(3) COMP-3 | DECIMAL(15,3) | Price per unit |

#### Financial Amounts

| Field | Picture | DB2 Type | Description |
|-------|---------|----------|-------------|
| PH-AMOUNT | S9(13)V9(2) COMP-3 | DECIMAL(15,2) | Base transaction amount |
| PH-FEES | S9(13)V9(2) COMP-3 | DECIMAL(15,2) | Transaction fees/commissions |
| PH-TOTAL-AMOUNT | S9(13)V9(2) COMP-3 | DECIMAL(15,2) | Total amount (amount + fees) |
| PH-COST-BASIS | S9(13)V9(2) COMP-3 | DECIMAL(15,2) | Cost basis for tax purposes |
| PH-GAIN-LOSS | S9(13)V9(2) COMP-3 | DECIMAL(15,2) | Realized gain or loss |

#### Audit Information

| Field | Picture | DB2 Type | Description |
|-------|---------|----------|-------------|
| PH-PROCESS-DATE | X(10) | DATE | Date record was processed |
| PH-PROCESS-TIME | X(8) | TIME | Time record was processed |
| PH-PROGRAM-ID | X(8) | CHAR(8) | Program that created record |
| PH-USER-ID | X(8) | CHAR(8) | User who initiated transaction |
| PH-AUDIT-TIMESTAMP | X(26) | TIMESTAMP | Full audit timestamp |

### Transaction Type Codes

| Code | Description |
|------|-------------|
| BY | Buy/Purchase |
| SL | Sell |
| DV | Dividend |
| IN | Interest |
| TR | Transfer In |
| TO | Transfer Out |
| FE | Fee Charge |
| AD | Adjustment |

### Record Layout Diagram

```
+----------+------------+------------+----------+
| ACCT-NO  | PORTFOLIO  | TRANS-DATE | TRANS-   |
| (8)      | -ID (10)   | (10)       | TIME (8) |
+----------+------------+------------+----------+
| TRANS | SECURITY-ID  | QUANTITY      | PRICE        |
| (2)   | (12)         | COMP-3 (8)    | COMP-3 (8)   |
+-------+--------------+---------------+--------------+
| AMOUNT     | FEES       | TOTAL-AMT  | COST-BASIS |
| COMP-3 (8) | COMP-3 (8) | COMP-3 (8) | COMP-3 (8) |
+-----------+------------+------------+------------+
| GAIN-LOSS  | PROC-DATE | PROC-TIME | PROGRAM | USER  |
| COMP-3 (8) | (10)      | (8)       | (8)     | (8)   |
+------------+-----------+-----------+---------+-------+
| AUDIT-TIMESTAMP (26)                                 |
+------------------------------------------------------+
```

## Error Log Table (ERRLOG-RECORD)

The ERRLOG-RECORD structure maps to the Error Log table, which stores application errors for troubleshooting and audit purposes.

### Field Definitions

#### Identification Fields

| Field | Picture | DB2 Type | Description |
|-------|---------|----------|-------------|
| EL-ERROR-TIMESTAMP | X(26) | TIMESTAMP | When error occurred |
| EL-PROGRAM-ID | X(8) | CHAR(8) | Program that logged error |

#### Error Classification

| Field | Picture | DB2 Type | Description |
|-------|---------|----------|-------------|
| EL-ERROR-TYPE | X(1) | CHAR(1) | Error type category |
| EL-ERROR-SEVERITY | S9(4) COMP | SMALLINT | Severity level |
| EL-ERROR-CODE | X(8) | CHAR(8) | Application error code |

#### Error Details

| Field | Picture | DB2 Type | Description |
|-------|---------|----------|-------------|
| EL-ERROR-MESSAGE | X(200) | VARCHAR(200) | Error message text |
| EL-ADDITIONAL-INFO | X(500) | VARCHAR(500) | Extended error details |

#### Audit Fields

| Field | Picture | DB2 Type | Description |
|-------|---------|----------|-------------|
| EL-PROCESS-DATE | X(10) | DATE | Processing date |
| EL-PROCESS-TIME | X(8) | TIME | Processing time |
| EL-USER-ID | X(8) | CHAR(8) | User context |

### Error Type Values (EL-ERROR-TYPE)

| Value | 88-Level | Description |
|-------|----------|-------------|
| 'S' | EL-TYPE-SYSTEM | System-level error (DB2, VSAM, etc.) |
| 'A' | EL-TYPE-APP | Application logic error |
| 'D' | EL-TYPE-DATA | Data validation error |

### Error Severity Values (EL-ERROR-SEVERITY)

| Value | 88-Level | Description |
|-------|----------|-------------|
| 1 | EL-SEV-INFO | Informational message |
| 2 | EL-SEV-WARN | Warning - processing continued |
| 3 | EL-SEV-ERROR | Error - record skipped |
| 4 | EL-SEV-SEVERE | Severe - processing stopped |

## Usage

### Including the Copybook

```cobol
WORKING-STORAGE SECTION.
    COPY DBTBLS.
```

### Example: Inserting a Transaction Record

```cobol
MOVE WS-ACCOUNT        TO PH-ACCOUNT-NO
MOVE WS-PORTFOLIO      TO PH-PORTFOLIO-ID
MOVE WS-TRANS-DATE     TO PH-TRANS-DATE
MOVE WS-TRANS-TIME     TO PH-TRANS-TIME
MOVE 'BY'              TO PH-TRANS-TYPE
MOVE WS-SECURITY       TO PH-SECURITY-ID
MOVE WS-QUANTITY       TO PH-QUANTITY
MOVE WS-PRICE          TO PH-PRICE
COMPUTE PH-AMOUNT = PH-QUANTITY * PH-PRICE
MOVE WS-FEES           TO PH-FEES
COMPUTE PH-TOTAL-AMOUNT = PH-AMOUNT + PH-FEES
MOVE ZEROS             TO PH-COST-BASIS
MOVE ZEROS             TO PH-GAIN-LOSS
ACCEPT PH-PROCESS-DATE FROM DATE YYYYMMDD
ACCEPT PH-PROCESS-TIME FROM TIME
MOVE 'PORTTRAN'        TO PH-PROGRAM-ID
MOVE WS-USER-ID        TO PH-USER-ID

EXEC SQL
    INSERT INTO POSHIST
    (ACCOUNT_NO, PORTFOLIO_ID, TRANS_DATE, TRANS_TIME,
     TRANS_TYPE, SECURITY_ID, QUANTITY, PRICE,
     AMOUNT, FEES, TOTAL_AMOUNT, COST_BASIS, GAIN_LOSS,
     PROCESS_DATE, PROCESS_TIME, PROGRAM_ID, USER_ID,
     AUDIT_TIMESTAMP)
    VALUES
    (:PH-ACCOUNT-NO, :PH-PORTFOLIO-ID, :PH-TRANS-DATE,
     :PH-TRANS-TIME, :PH-TRANS-TYPE, :PH-SECURITY-ID,
     :PH-QUANTITY, :PH-PRICE, :PH-AMOUNT, :PH-FEES,
     :PH-TOTAL-AMOUNT, :PH-COST-BASIS, :PH-GAIN-LOSS,
     :PH-PROCESS-DATE, :PH-PROCESS-TIME, :PH-PROGRAM-ID,
     :PH-USER-ID, CURRENT TIMESTAMP)
END-EXEC
```

### Example: Logging an Error

```cobol
MOVE FUNCTION CURRENT-DATE TO EL-ERROR-TIMESTAMP
MOVE 'HISTLD00'            TO EL-PROGRAM-ID
SET EL-TYPE-DATA           TO TRUE
SET EL-SEV-ERROR           TO TRUE
MOVE 'INVL0001'            TO EL-ERROR-CODE
STRING 'Invalid account number: ' DELIMITED SIZE
       WS-ACCOUNT DELIMITED SPACE
       INTO EL-ERROR-MESSAGE
MOVE WS-INPUT-RECORD       TO EL-ADDITIONAL-INFO
ACCEPT EL-PROCESS-DATE FROM DATE YYYYMMDD
ACCEPT EL-PROCESS-TIME FROM TIME
MOVE WS-USER-ID            TO EL-USER-ID

EXEC SQL
    INSERT INTO ERRLOG
    (ERROR_TIMESTAMP, PROGRAM_ID, ERROR_TYPE, ERROR_SEVERITY,
     ERROR_CODE, ERROR_MESSAGE, PROCESS_DATE, PROCESS_TIME,
     USER_ID, ADDITIONAL_INFO)
    VALUES
    (:EL-ERROR-TIMESTAMP, :EL-PROGRAM-ID, :EL-ERROR-TYPE,
     :EL-ERROR-SEVERITY, :EL-ERROR-CODE, :EL-ERROR-MESSAGE,
     :EL-PROCESS-DATE, :EL-PROCESS-TIME, :EL-USER-ID,
     :EL-ADDITIONAL-INFO)
END-EXEC
```

### Example: Querying Transaction History

```cobol
EXEC SQL
    SELECT TRANS_DATE, TRANS_TYPE, QUANTITY, PRICE,
           TOTAL_AMOUNT
    INTO :PH-TRANS-DATE, :PH-TRANS-TYPE, :PH-QUANTITY,
         :PH-PRICE, :PH-TOTAL-AMOUNT
    FROM POSHIST
    WHERE ACCOUNT_NO = :WS-ACCOUNT
      AND PORTFOLIO_ID = :WS-PORTFOLIO
    ORDER BY TRANS_DATE DESC, TRANS_TIME DESC
    FETCH FIRST 1 ROW ONLY
END-EXEC
```

## Programs Using This Copybook

| Program | Description |
|---------|-------------|
| HISTLD00 | History load program - loads transaction history to DB2 |

## Related Copybooks

| Copybook | Relationship |
|----------|--------------|
| SQLCA | SQL Communication Area - for checking SQL return codes |
| DBPROC | DB2 processing routines - common DB2 operations |
| HISTREC | History record layout - flat file format for history data |

## Database Schema

### POSHIST Table DDL

```sql
CREATE TABLE POSHIST (
    ACCOUNT_NO      CHAR(8) NOT NULL,
    PORTFOLIO_ID    CHAR(10) NOT NULL,
    TRANS_DATE      DATE NOT NULL,
    TRANS_TIME      TIME NOT NULL,
    TRANS_TYPE      CHAR(2) NOT NULL,
    SECURITY_ID     CHAR(12),
    QUANTITY        DECIMAL(15,3),
    PRICE           DECIMAL(15,3),
    AMOUNT          DECIMAL(15,2),
    FEES            DECIMAL(15,2),
    TOTAL_AMOUNT    DECIMAL(15,2),
    COST_BASIS      DECIMAL(15,2),
    GAIN_LOSS       DECIMAL(15,2),
    PROCESS_DATE    DATE,
    PROCESS_TIME    TIME,
    PROGRAM_ID      CHAR(8),
    USER_ID         CHAR(8),
    AUDIT_TIMESTAMP TIMESTAMP,
    PRIMARY KEY (ACCOUNT_NO, PORTFOLIO_ID, TRANS_DATE, TRANS_TIME)
);

CREATE INDEX POSHIST_PORT_IDX ON POSHIST (PORTFOLIO_ID);
CREATE INDEX POSHIST_DATE_IDX ON POSHIST (TRANS_DATE);
```

### ERRLOG Table DDL

```sql
CREATE TABLE ERRLOG (
    ERROR_TIMESTAMP TIMESTAMP NOT NULL,
    PROGRAM_ID      CHAR(8) NOT NULL,
    ERROR_TYPE      CHAR(1) NOT NULL,
    ERROR_SEVERITY  SMALLINT NOT NULL,
    ERROR_CODE      CHAR(8),
    ERROR_MESSAGE   VARCHAR(200),
    PROCESS_DATE    DATE,
    PROCESS_TIME    TIME,
    USER_ID         CHAR(8),
    ADDITIONAL_INFO VARCHAR(500),
    PRIMARY KEY (ERROR_TIMESTAMP, PROGRAM_ID)
);

CREATE INDEX ERRLOG_DATE_IDX ON ERRLOG (PROCESS_DATE);
CREATE INDEX ERRLOG_SEV_IDX ON ERRLOG (ERROR_SEVERITY);
```

## Technical Notes

### COMP-3 (Packed Decimal)

All numeric amount fields use `COMP-3` (packed decimal) format:
- Efficient storage (approximately half the bytes of display format)
- Matches DB2 DECIMAL data type directly
- Suitable for financial calculations without floating-point rounding issues

### Data Type Mapping

| COBOL | DB2 | Notes |
|-------|-----|-------|
| PIC X(n) | CHAR(n) | Fixed-length character |
| PIC S9(p)V9(s) COMP-3 | DECIMAL(p+s, s) | Packed decimal |
| PIC S9(4) COMP | SMALLINT | Binary halfword |
| X(10) for dates | DATE | Format: YYYY-MM-DD |
| X(8) for times | TIME | Format: HH:MM:SS |
| X(26) for timestamps | TIMESTAMP | ISO format |

### Null Handling

The copybook structures do not include null indicator variables. If null values are possible, programs should declare separate indicator arrays:

```cobol
01  PH-INDICATORS.
    05  PH-SECURITY-ID-IND    PIC S9(4) COMP.
    05  PH-QUANTITY-IND       PIC S9(4) COMP.
    ...
```

### Record Lengths

| Structure | Approximate Length |
|-----------|-------------------|
| POSHIST-RECORD | ~170 bytes |
| ERRLOG-RECORD | ~780 bytes |

## Version History

| Version | Date | Description |
|---------|------|-------------|
| 1.0 | 2024 | Initial creation |
