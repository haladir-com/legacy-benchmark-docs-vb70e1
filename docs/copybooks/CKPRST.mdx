---
title: "CKPRST"
description: "Checkpoint/Restart Control Structure - Copybook providing data structures for batch checkpoint/restart functionality"
---

## Overview

CKPRST is a COBOL copybook that defines the data structures used for checkpoint/restart functionality in batch programs. It provides a standardized framework for:

- **Checkpoint management** - Recording processing state at regular intervals
- **Restart capability** - Resuming processing after failures from the last checkpoint
- **Resource tracking** - Monitoring file positions and processing counters
- **Error control** - Managing error thresholds and restart limits

This copybook is essential for long-running batch jobs that need recoverability. By taking periodic checkpoints, programs can resume processing from the last committed point rather than restarting from the beginning after a failure.

## Data Structures

### CHECKPOINT-CONTROL

The main checkpoint control structure containing all checkpoint state information.

#### CK-HEADER (Run Identification)

| Level | Name | Picture | Description |
|-------|------|---------|-------------|
| 10 | CK-PROGRAM-ID | PIC X(8) | Program name for checkpoint identification |
| 10 | CK-RUN-DATE | PIC X(8) | Run date (YYYYMMDD format) |
| 10 | CK-RUN-TIME | PIC X(6) | Run time (HHMMSS format) |
| 10 | CK-STATUS | PIC X(1) | Current checkpoint status |

##### Status Codes (88-levels)

| Condition | Value | Description |
|-----------|-------|-------------|
| CK-INITIAL | 'I' | Initial state - processing not started |
| CK-ACTIVE | 'A' | Active - processing in progress |
| CK-COMPLETE | 'C' | Complete - processing finished successfully |
| CK-FAILED | 'F' | Failed - processing terminated with error |
| CK-RESTARTED | 'R' | Restarted - resumed from checkpoint |

#### CK-COUNTERS (Processing Statistics)

| Level | Name | Picture | Description |
|-------|------|---------|-------------|
| 10 | CK-RECORDS-READ | PIC 9(9) COMP | Total records read |
| 10 | CK-RECORDS-PROC | PIC 9(9) COMP | Records successfully processed |
| 10 | CK-RECORDS-ERROR | PIC 9(9) COMP | Records with errors |
| 10 | CK-RESTART-COUNT | PIC 9(2) COMP | Number of restart attempts |

#### CK-POSITION (Processing Position)

| Level | Name | Picture | Description |
|-------|------|---------|-------------|
| 10 | CK-LAST-KEY | PIC X(50) | Last successfully processed record key |
| 10 | CK-LAST-TIME | PIC X(26) | Timestamp of last checkpoint |
| 10 | CK-PHASE | PIC X(2) | Current processing phase |

##### Phase Codes (88-levels)

| Condition | Value | Description |
|-----------|-------|-------------|
| CK-PHASE-INIT | '00' | Initialization phase |
| CK-PHASE-READ | '10' | Reading input phase |
| CK-PHASE-PROC | '20' | Processing phase |
| CK-PHASE-UPDT | '30' | Update/output phase |
| CK-PHASE-TERM | '40' | Termination phase |

#### CK-RESOURCES (File Tracking)

Tracks up to 5 files with their positions:

| Level | Name | Picture | Occurs | Description |
|-------|------|---------|--------|-------------|
| 10 | CK-FILE-STATUS | - | 5 | File status array |
| 15 | CK-FILE-NAME | PIC X(8) | - | Logical file name |
| 15 | CK-FILE-POS | PIC X(50) | - | Current file position/key |
| 15 | CK-FILE-STATUS | PIC X(2) | - | File status code |

#### CK-CONTROL-INFO (Configuration)

| Level | Name | Picture | Default | Description |
|-------|------|---------|---------|-------------|
| 10 | CK-COMMIT-FREQ | PIC 9(5) COMP | 1000 | Records between checkpoints |
| 10 | CK-MAX-ERRORS | PIC 9(3) COMP | 100 | Maximum errors before abort |
| 10 | CK-MAX-RESTARTS | PIC 9(2) COMP | 3 | Maximum restart attempts |
| 10 | CK-RESTART-MODE | PIC X(1) | - | Current restart mode |

##### Restart Mode Codes (88-levels)

| Condition | Value | Description |
|-----------|-------|-------------|
| CK-MODE-NORMAL | 'N' | Normal processing (no restart) |
| CK-MODE-RESTART | 'R' | Restart from last checkpoint |
| CK-MODE-RECOVER | 'C' | Recovery mode (special handling) |

### CHECKPOINT-RECORD

VSAM file record structure for persisting checkpoint data:

| Level | Name | Picture | Description |
|-------|------|---------|-------------|
| 01 | CHECKPOINT-RECORD | - | Complete checkpoint file record |
| 05 | CKR-KEY | - | Composite record key |
| 10 | CKR-PROGRAM-ID | PIC X(8) | Program identifier |
| 10 | CKR-RUN-DATE | PIC X(8) | Run date |
| 05 | CKR-DATA | PIC X(400) | Checkpoint data payload |

**Total Record Size**: 416 bytes (8 + 8 + 400)

## Standard Processing Routines

The copybook documents four standard checkpoint processing routines:

### CKPINIT - Checkpoint Initialize

```cobol
CALL 'CKPINIT' USING CHECKPOINT-CONTROL
                     RETURN-STATUS
```

Initializes checkpoint control structures at program start. Checks for existing checkpoint records to determine if restart is needed.

### CKPTAKE - Take Checkpoint

```cobol
CALL 'CKPTAKE' USING CHECKPOINT-CONTROL
                     RETURN-STATUS
```

Records current processing state. Typically called every CK-COMMIT-FREQ records or at significant processing milestones.

### CKPCMIT - Checkpoint Commit

```cobol
CALL 'CKPCMIT' USING CHECKPOINT-CONTROL
                     RETURN-STATUS
```

Commits the checkpoint to persistent storage. Often combined with database commits to ensure consistency.

### CKPRSTR - Checkpoint Restart

```cobol
CALL 'CKPRSTR' USING CHECKPOINT-CONTROL
                     RETURN-STATUS
```

Restores processing state from the last committed checkpoint. Repositions files and restores counters.

## Usage Pattern

### Typical Checkpoint/Restart Flow

```cobol
WORKING-STORAGE SECTION.
    COPY CKPRST.
    
01  WS-RETURN-STATUS    PIC S9(4) COMP.
01  WS-RECORD-COUNT     PIC 9(9) COMP VALUE 0.

PROCEDURE DIVISION.
0000-MAIN.
    *> Initialize checkpoint - check for restart
    CALL 'CKPINIT' USING CHECKPOINT-CONTROL
                         WS-RETURN-STATUS
    
    IF CK-MODE-RESTART
        CALL 'CKPRSTR' USING CHECKPOINT-CONTROL
                             WS-RETURN-STATUS
        *> Reposition files to CK-LAST-KEY
        PERFORM 1000-REPOSITION-FILES
    END-IF
    
    MOVE 'A' TO CK-STATUS
    PERFORM 2000-PROCESS-RECORDS
    
    MOVE 'C' TO CK-STATUS
    CALL 'CKPCMIT' USING CHECKPOINT-CONTROL
                         WS-RETURN-STATUS
    GOBACK.

2000-PROCESS-RECORDS.
    PERFORM UNTIL END-OF-FILE
        READ INPUT-FILE
            AT END SET END-OF-FILE TO TRUE
            NOT AT END
                PERFORM 2100-PROCESS-ONE-RECORD
                ADD 1 TO WS-RECORD-COUNT
                ADD 1 TO CK-RECORDS-READ
                
                *> Take checkpoint every CK-COMMIT-FREQ records
                IF WS-RECORD-COUNT >= CK-COMMIT-FREQ
                    MOVE INPUT-KEY TO CK-LAST-KEY
                    CALL 'CKPTAKE' USING CHECKPOINT-CONTROL
                                         WS-RETURN-STATUS
                    CALL 'CKPCMIT' USING CHECKPOINT-CONTROL
                                         WS-RETURN-STATUS
                    MOVE 0 TO WS-RECORD-COUNT
                END-IF
        END-READ
    END-PERFORM.
```

### Restart Detection

```cobol
*> Check if this is a restart situation
CALL 'CKPINIT' USING CHECKPOINT-CONTROL
                     WS-RETURN-STATUS

EVALUATE TRUE
    WHEN CK-MODE-NORMAL
        *> Fresh start - initialize everything
        PERFORM 1000-NORMAL-INIT
    WHEN CK-MODE-RESTART
        *> Restart - restore from checkpoint
        DISPLAY 'Restarting from checkpoint'
        DISPLAY '  Last key: ' CK-LAST-KEY
        DISPLAY '  Records processed: ' CK-RECORDS-PROC
        PERFORM 1100-RESTART-INIT
    WHEN CK-MODE-RECOVER
        *> Recovery mode - special handling
        PERFORM 1200-RECOVERY-INIT
END-EVALUATE
```

## Dependencies

### Related Copybooks

- **RETHND** - Return handling copybook (used with CKPRST in program CKPRST)

### Supporting Programs

The copybook references four external checkpoint processing programs:

| Program | Purpose |
|---------|---------|
| CKPINIT | Initialize checkpoint control |
| CKPTAKE | Take a checkpoint |
| CKPCMIT | Commit checkpoint to storage |
| CKPRSTR | Restore from checkpoint |

## Programs Using This Copybook

| Program | Description |
|---------|-------------|
| CKPRST | Checkpoint/restart processing program |

## Technical Notes

### Checkpoint File Design

The CHECKPOINT-RECORD structure uses a composite key of:
- Program ID (8 bytes)
- Run Date (8 bytes)

This allows multiple programs to share a checkpoint file while maintaining separate checkpoint records. Each program/date combination has its own checkpoint history.

### Commit Frequency Tuning

The default CK-COMMIT-FREQ of 1000 records balances:
- **Performance**: Fewer commits = less overhead
- **Recovery time**: More frequent commits = less re-work on restart
- **Resource usage**: Checkpoints consume I/O and storage

Adjust based on:
- Record processing time
- Acceptable recovery time
- System I/O capacity

### Error Threshold

The CK-MAX-ERRORS default of 100 provides:
- Tolerance for occasional bad records
- Protection against runaway error conditions
- Configurable per-job requirements

### Restart Limit

CK-MAX-RESTARTS default of 3 prevents:
- Infinite restart loops
- Resource exhaustion from repeated failures
- Operator intervention requirement after limit reached

### Phase Tracking

The CK-PHASE field enables:
- Precise restart positioning within complex jobs
- Phase-specific recovery logic
- Progress monitoring and reporting

### File Position Array

The 5-element CK-FILE-STATUS array supports:
- Multiple input/output files
- Independent file positioning on restart
- File status tracking for each resource

### Timestamp Format

CK-LAST-TIME uses 26 characters to accommodate:
- DB2 timestamp format: `YYYY-MM-DD-HH.MM.SS.NNNNNN`
- Enables precise checkpoint timing
- Supports audit and debugging requirements
