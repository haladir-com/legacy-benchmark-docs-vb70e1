---
title: "SQLCA"
description: "SQL Communication Area - DB2 status codes and diagnostic information for embedded SQL"
---

## Overview

SQLCA is a copybook that provides the SQL Communication Area structure and common SQLSTATE codes for DB2 database operations. It includes the standard IBM DB2 SQLCA via `EXEC SQL INCLUDE SQLCA` and adds application-specific SQLSTATE constants for common error conditions.

The SQLCA is essential for any COBOL program that uses embedded SQL. After each SQL statement executes, DB2 populates the SQLCA with:
- Return codes indicating success or failure
- Diagnostic information about errors
- Row counts and other operation statistics

## Copybook Contents

This copybook contains two parts:

1. **Standard SQLCA**: Included via `EXEC SQL INCLUDE SQLCA END-EXEC`
2. **SQL-STATUS-CODES**: Application-defined SQLSTATE constants

### EXEC SQL INCLUDE SQLCA

The `EXEC SQL INCLUDE SQLCA` directive instructs the DB2 precompiler to insert the standard SQLCA structure. This is equivalent to:

```cobol
01  SQLCA.
    05  SQLCAID        PIC X(8) VALUE 'SQLCA   '.
    05  SQLCABC        PIC S9(9) COMP-5 VALUE 136.
    05  SQLCODE        PIC S9(9) COMP-5.
    05  SQLERRM.
        49  SQLERRML   PIC S9(4) COMP-5.
        49  SQLERRMC   PIC X(70).
    05  SQLERRP        PIC X(8).
    05  SQLERRD        OCCURS 6 TIMES PIC S9(9) COMP-5.
    05  SQLWARN.
        10  SQLWARN0   PIC X.
        10  SQLWARN1   PIC X.
        10  SQLWARN2   PIC X.
        10  SQLWARN3   PIC X.
        10  SQLWARN4   PIC X.
        10  SQLWARN5   PIC X.
        10  SQLWARN6   PIC X.
        10  SQLWARN7   PIC X.
        10  SQLWARN8   PIC X.
        10  SQLWARN9   PIC X.
        10  SQLWARNA   PIC X.
    05  SQLSTATE       PIC X(5).
```

### SQL Status Codes (SQL-STATUS-CODES)

Application-defined constants for common SQLSTATE values:

| Level | Name | Picture | Value | Description |
|-------|------|---------|-------|-------------|
| 01 | SQL-STATUS-CODES | - | - | SQLSTATE constants |
| 05 | SQL-SUCCESS | X(5) | `'00000'` | Successful completion |
| 05 | SQL-NOT-FOUND | X(5) | `'02000'` | No data found |
| 05 | SQL-DUP-KEY | X(5) | `'23505'` | Duplicate key violation |
| 05 | SQL-DEADLOCK | X(5) | `'40001'` | Deadlock detected |
| 05 | SQL-TIMEOUT | X(5) | `'40003'` | Statement timeout |
| 05 | SQL-CONNECTION-ERROR | X(5) | `'08001'` | Connection failure |
| 05 | SQL-DB-ERROR | X(5) | `'58004'` | System error |

## Standard SQLCA Fields

### Primary Fields

| Field | Picture | Description |
|-------|---------|-------------|
| SQLCAID | X(8) | Eye-catcher identifier (`'SQLCA   '`) |
| SQLCABC | S9(9) COMP-5 | Length of SQLCA (136 bytes) |
| SQLCODE | S9(9) COMP-5 | SQL return code |
| SQLERRM | - | Error message group |
| SQLERRML | S9(4) COMP-5 | Length of error message |
| SQLERRMC | X(70) | Error message text |
| SQLERRP | X(8) | Product identifier |
| SQLERRD | S9(9) COMP-5 OCCURS 6 | Diagnostic information array |
| SQLWARN | - | Warning flags group |
| SQLSTATE | X(5) | SQLSTATE status code |

### SQLCODE Values

| Value | Meaning |
|-------|---------|
| 0 | Successful execution |
| 100 | No data found (end of cursor, no rows) |
| < 0 | Error occurred |
| > 0 (not 100) | Warning condition |

### Common SQLCODE Values

| SQLCODE | Description |
|---------|-------------|
| 0 | Success |
| 100 | Row not found / End of data |
| -803 | Duplicate key on insert |
| -811 | Multiple rows returned for single fetch |
| -818 | Timestamp mismatch (plan/package) |
| -904 | Resource unavailable |
| -911 | Deadlock or timeout |
| -913 | Unsuccessful execution - deadlock |

### SQLERRD Array

| Element | Description |
|---------|-------------|
| SQLERRD(1) | Reserved |
| SQLERRD(2) | Reserved |
| SQLERRD(3) | Number of rows affected by INSERT/UPDATE/DELETE |
| SQLERRD(4) | Relative cost estimate |
| SQLERRD(5) | Position of syntax error |
| SQLERRD(6) | Reserved |

### SQLWARN Flags

| Flag | Meaning When `'W'` |
|------|-------------------|
| SQLWARN0 | At least one other warning flag is set |
| SQLWARN1 | String column truncated |
| SQLWARN2 | NULL values eliminated from function |
| SQLWARN3 | Number of columns != number of host variables |
| SQLWARN4 | UPDATE/DELETE without WHERE clause |
| SQLWARN5 | SQL statement not valid for execution |
| SQLWARN6 | Date arithmetic resulted in end-of-month adjustment |
| SQLWARN7 | Reserved |
| SQLWARN8 | Character could not be converted |
| SQLWARN9 | Reserved |
| SQLWARNA | Reserved |

### SQLSTATE Classes

SQLSTATE is a 5-character code where the first 2 characters indicate the class:

| Class | Description |
|-------|-------------|
| 00 | Successful completion |
| 01 | Warning |
| 02 | No data |
| 07 | Dynamic SQL error |
| 08 | Connection exception |
| 21 | Cardinality violation |
| 22 | Data exception |
| 23 | Constraint violation |
| 24 | Invalid cursor state |
| 26 | Invalid SQL statement identifier |
| 40 | Transaction rollback |
| 42 | Syntax error or access rule violation |
| 51 | Invalid application state |
| 54 | SQL or product limit exceeded |
| 55 | Object not in prerequisite state |
| 56 | Miscellaneous SQL or product error |
| 57 | Resource not available |
| 58 | System error |

## Usage Examples

### Checking SQL Success

```cobol
WORKING-STORAGE SECTION.
    COPY SQLCA.

PROCEDURE DIVISION.
    ...
    EXEC SQL
        SELECT PORTFOLIO_NAME
        INTO :WS-PORTFOLIO-NAME
        FROM PORTFOLIO
        WHERE PORTFOLIO_ID = :WS-PORTFOLIO-ID
    END-EXEC
    
    EVALUATE TRUE
        WHEN SQLCODE = 0
            CONTINUE
        WHEN SQLCODE = 100
            MOVE 'Portfolio not found' TO WS-ERROR-MSG
            PERFORM HANDLE-NOT-FOUND
        WHEN SQLCODE < 0
            PERFORM HANDLE-SQL-ERROR
    END-EVALUATE
    ...
```

### Using SQLSTATE Constants

```cobol
    EXEC SQL
        INSERT INTO PORTFOLIO
        (PORTFOLIO_ID, PORTFOLIO_NAME, STATUS)
        VALUES (:WS-ID, :WS-NAME, :WS-STATUS)
    END-EXEC
    
    EVALUATE SQLSTATE
        WHEN SQL-SUCCESS
            CONTINUE
        WHEN SQL-DUP-KEY
            MOVE 'Duplicate portfolio ID' TO WS-ERROR-MSG
            PERFORM HANDLE-DUPLICATE
        WHEN SQL-DEADLOCK
            PERFORM HANDLE-DEADLOCK-RETRY
        WHEN OTHER
            PERFORM HANDLE-SQL-ERROR
    END-EVALUATE
```

### Retrieving Row Count

```cobol
    EXEC SQL
        UPDATE PORTFOLIO
        SET STATUS = 'C'
        WHERE LAST_ACTIVITY < :WS-CUTOFF-DATE
    END-EXEC
    
    IF SQLCODE = 0
        MOVE SQLERRD(3) TO WS-ROWS-UPDATED
        DISPLAY 'Portfolios closed: ' WS-ROWS-UPDATED
    END-IF
```

### Comprehensive Error Handling

```cobol
HANDLE-SQL-ERROR.
    DISPLAY '=========================================='
    DISPLAY 'SQL ERROR OCCURRED'
    DISPLAY '=========================================='
    DISPLAY 'SQLCODE:    ' SQLCODE
    DISPLAY 'SQLSTATE:   ' SQLSTATE
    DISPLAY 'SQLERRMC:   ' SQLERRMC(1:SQLERRML)
    DISPLAY 'SQLERRD(3): ' SQLERRD(3)
    DISPLAY '=========================================='
    
    EVALUATE TRUE
        WHEN SQLSTATE = SQL-DEADLOCK
            PERFORM ATTEMPT-RETRY
        WHEN SQLSTATE = SQL-TIMEOUT
            PERFORM ATTEMPT-RETRY
        WHEN SQLSTATE = SQL-CONNECTION-ERROR
            PERFORM RECONNECT-DB2
        WHEN OTHER
            MOVE SQLCODE TO WS-SQL-RETURN-CODE
            MOVE SQLERRMC TO WS-SQL-ERROR-MSG
            SET WS-FATAL-ERROR TO TRUE
    END-EVALUATE.
```

### Cursor Processing with SQLCA

```cobol
    EXEC SQL DECLARE PORTFOLIO_CURSOR CURSOR FOR
        SELECT PORTFOLIO_ID, PORTFOLIO_NAME
        FROM PORTFOLIO
        WHERE STATUS = 'A'
    END-EXEC
    
    EXEC SQL OPEN PORTFOLIO_CURSOR END-EXEC
    
    IF SQLCODE NOT = 0
        PERFORM HANDLE-SQL-ERROR
        GO TO CURSOR-EXIT
    END-IF
    
    PERFORM UNTIL SQLCODE = 100
        EXEC SQL
            FETCH PORTFOLIO_CURSOR
            INTO :WS-PORTFOLIO-ID, :WS-PORTFOLIO-NAME
        END-EXEC
        
        IF SQLCODE = 0
            PERFORM PROCESS-PORTFOLIO
        ELSE IF SQLCODE NOT = 100
            PERFORM HANDLE-SQL-ERROR
        END-IF
    END-PERFORM
    
    EXEC SQL CLOSE PORTFOLIO_CURSOR END-EXEC.
    
CURSOR-EXIT.
    EXIT.
```

## Programs Using This Copybook

| Program | Purpose |
|---------|---------|
| HISTLD00 | History data loading with DB2 |
| DB2CMT | DB2 commit handling |
| DB2CONN | DB2 connection management |
| DB2ERR | DB2 error handling |
| DB2STAT | DB2 statistics collection |

## Related Copybooks

| Copybook | Relationship |
|----------|--------------|
| DBPROC | DB2 processing procedures |
| DBTBLS | DB2 table definitions |
| ERRHAND | General error handling (complements SQL errors) |

## Technical Notes

### DB2 Precompiler

The `EXEC SQL INCLUDE SQLCA END-EXEC` statement is processed by the DB2 precompiler, not the COBOL compiler. The precompiler:
1. Expands the INCLUDE into the full SQLCA structure
2. Replaces EXEC SQL statements with CALL statements
3. Generates a modified source file for COBOL compilation

### SQLCODE vs SQLSTATE

| Aspect | SQLCODE | SQLSTATE |
|--------|---------|----------|
| Format | Integer | 5-char string |
| Standard | DB2-specific | SQL standard (ISO) |
| Portability | Limited | High |
| Granularity | Product-specific | Standardized classes |
| Recommendation | Legacy code | New development |

### Thread Safety

Each thread/task should have its own SQLCA. In CICS, the SQLCA is automatically managed per task. In batch, each run unit has its own SQLCA.

### Performance Considerations

- Check SQLCODE after every SQL statement
- Use SQLSTATE for portable error handling
- SQLERRD(3) is populated only for INSERT/UPDATE/DELETE
- Warning flags (SQLWARN) indicate non-fatal issues that may need attention

### Best Practices

1. **Always check SQLCODE**: Never assume SQL success
2. **Use constants**: Compare SQLSTATE against defined constants
3. **Log diagnostics**: Include SQLCODE, SQLSTATE, and SQLERRMC in error logs
4. **Handle +100**: Not finding data may be normal (end of cursor)
5. **Retry deadlocks**: SQLSTATE '40001' often succeeds on retry
6. **Check warnings**: SQLWARN0 = 'W' means check other flags
