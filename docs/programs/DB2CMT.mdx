---
title: "DB2CMT"
description: "DB2 Commit Controller - Reusable subprogram for managing DB2 transaction commit, rollback, and savepoint operations"
---

## Overview

DB2CMT is a callable subprogram that provides centralized control over DB2 transaction management operations. It serves as a reusable commit controller that can be called by any batch or online program requiring DB2 commit, rollback, or savepoint functionality.

The program supports six functions:
- **INIT** - Initialize commit statistics
- **CMIT** - Conditional or forced commit
- **RBAK** - Full rollback
- **SAVE** - Create a named savepoint
- **REST** - Restore to a named savepoint
- **STAT** - Display commit/rollback statistics

By centralizing transaction control in a single subprogram, DB2CMT promotes consistent commit strategies across applications, simplifies maintenance, and provides built-in statistics tracking for performance monitoring and debugging.

## Program Structure

```mermaid
graph TD
    A[0000-MAIN] --> B{EVALUATE Function}
    B -->|INIT| C[1000-INITIALIZE]
    B -->|CMIT| D[2000-COMMIT]
    B -->|RBAK| E[3000-ROLLBACK]
    B -->|SAVE| F[4000-SAVEPOINT]
    B -->|REST| G[5000-RESTORE]
    B -->|STAT| H[6000-STATISTICS]
    B -->|OTHER| I[9000-ERROR-ROUTINE]
    
    D --> D1[2100-ISSUE-COMMIT]
    D1 -.->|On Error| J[9100-LOG-ERROR]
    E -.->|On Error| J
    F -.->|On Error| J
    G -.->|On Error| J
    
    I --> K[ERRPROC]
    J --> L[DB2ERR]
```

## Data Structures

### Working Storage

| Level | Name | Picture | Description |
|-------|------|---------|-------------|
| 01 | WS-SAVEPOINT-ID | X(18) | Host variable for savepoint name (SQL DECLARE) |
| 01 | WS-COMMIT-STATS | | Commit statistics group |
| 05 | WS-COMMIT-COUNT | S9(9) COMP | Number of commits issued |
| 05 | WS-ROLLBACK-COUNT | S9(9) COMP | Number of rollbacks issued |
| 05 | WS-SAVEPOINT-COUNT | S9(9) COMP | Number of savepoints created |
| 01 | WS-CURRENT-TIMESTAMP | X(26) | Current timestamp storage |

### Linkage Section (Calling Interface)

The program receives a single parameter structure from calling programs:

| Level | Name | Picture | Description |
|-------|------|---------|-------------|
| 01 | LS-COMMIT-REQUEST | | Main request structure |
| 05 | LS-FUNCTION | X(4) | Function code (see table below) |
| 05 | LS-SAVEPOINT-NAME | X(18) | Savepoint name for SAVE/REST functions |
| 05 | LS-COMMIT-PARMS | | Commit parameters group |
| 10 | LS-RECORDS-PROC | S9(9) COMP | Records processed since last commit |
| 10 | LS-COMMIT-FREQ | S9(4) COMP | Commit frequency threshold |
| 10 | LS-FORCE-FLAG | X(1) | Force commit flag ('Y' = force) |
| 05 | LS-RETURN-CODE | S9(4) COMP | Return code (0=success, 8=error, 12=severe) |
| 05 | LS-ERROR-INFO | | Error information group |
| 10 | LS-SQLCODE | S9(9) COMP | DB2 SQLCODE from failed operation |
| 10 | LS-ERROR-MSG | X(80) | Error message text |

### Function Codes

| Code | 88-Level Name | Description |
|------|---------------|-------------|
| INIT | FUNC-INIT | Initialize statistics counters |
| CMIT | FUNC-CMIT | Commit work (conditional or forced) |
| RBAK | FUNC-RBACK | Rollback work |
| SAVE | FUNC-SAVE | Create savepoint |
| REST | FUNC-REST | Restore to savepoint |
| STAT | FUNC-STAT | Display statistics |

## Calling Interface

### COBOL Call Example

```cobol
       01  WS-COMMIT-REQUEST.
           05  WS-FUNCTION         PIC X(4).
           05  WS-SAVEPOINT-NAME   PIC X(18).
           05  WS-COMMIT-PARMS.
               10  WS-RECORDS-PROC PIC S9(9) COMP.
               10  WS-COMMIT-FREQ  PIC S9(4) COMP.
               10  WS-FORCE-FLAG   PIC X(1).
           05  WS-RETURN-CODE      PIC S9(4) COMP.
           05  WS-ERROR-INFO.
               10  WS-SQLCODE      PIC S9(9) COMP.
               10  WS-ERROR-MSG    PIC X(80).
       
       * Initialize commit controller
           MOVE 'INIT' TO WS-FUNCTION
           CALL 'DB2CMT' USING WS-COMMIT-REQUEST
       
       * Conditional commit (every 1000 records)
           MOVE 'CMIT' TO WS-FUNCTION
           ADD 1 TO WS-RECORDS-PROC
           MOVE 1000 TO WS-COMMIT-FREQ
           MOVE 'N' TO WS-FORCE-FLAG
           CALL 'DB2CMT' USING WS-COMMIT-REQUEST
       
       * Force commit at end of processing
           MOVE 'CMIT' TO WS-FUNCTION
           MOVE 'Y' TO WS-FORCE-FLAG
           CALL 'DB2CMT' USING WS-COMMIT-REQUEST
```

## Control Flow

### INIT Function (1000-INITIALIZE)

Initializes the commit statistics counters to zero and sets the return code to 0. Should be called at the start of processing.

### CMIT Function (2000-COMMIT)

Performs a conditional commit based on either:
1. **Record count threshold**: If `LS-RECORDS-PROC >= LS-COMMIT-FREQ`
2. **Force flag**: If `LS-FORCE-FLAG = 'Y'`

When either condition is met, calls 2100-ISSUE-COMMIT which:
- Executes `EXEC SQL COMMIT WORK END-EXEC`
- On success (SQLCODE = 0): Increments commit counter, sets return code to 0
- On failure: Captures SQLCODE, sets error message, sets return code to 8, logs error via DB2ERR

### RBAK Function (3000-ROLLBACK)

Performs a full rollback of uncommitted work:
- Executes `EXEC SQL ROLLBACK WORK END-EXEC`
- On success: Increments rollback counter, sets return code to 0
- On failure: Captures SQLCODE, sets error message, sets return code to 8, logs error

### SAVE Function (4000-SAVEPOINT)

Creates a named savepoint for partial rollback capability:
- Copies `LS-SAVEPOINT-NAME` to host variable `WS-SAVEPOINT-ID`
- Executes `EXEC SQL SAVEPOINT :WS-SAVEPOINT-ID ON ROLLBACK RETAIN CURSORS END-EXEC`
- The `ON ROLLBACK RETAIN CURSORS` clause preserves cursor positions if a rollback to this savepoint occurs
- On success: Increments savepoint counter, sets return code to 0
- On failure: Captures SQLCODE, sets error message, sets return code to 8, logs error

### REST Function (5000-RESTORE)

Rolls back to a previously created savepoint:
- Copies `LS-SAVEPOINT-NAME` to host variable `WS-SAVEPOINT-ID`
- Executes `EXEC SQL ROLLBACK TO SAVEPOINT :WS-SAVEPOINT-ID END-EXEC`
- On success: Increments rollback counter, sets return code to 0
- On failure: Captures SQLCODE, sets error message, sets return code to 8, logs error

### STAT Function (6000-STATISTICS)

Displays commit controller statistics to SYSOUT:
```
DB2 Commit Controller Statistics:
  Commits:    nnnnnnnnn
  Rollbacks:  nnnnnnnnn
  Savepoints: nnnnnnnnn
```

### Error Handling

Two error routines handle different error scenarios:

**9000-ERROR-ROUTINE** - Invalid function code:
- Sets program name to 'DB2CMT' in error structure
- Sets return code to 12 (severe)
- Calls ERRPROC for error logging

**9100-LOG-ERROR** - DB2 operation failure:
- Calls DB2ERR with the error information structure
- Used for commit, rollback, and savepoint failures

## File I/O

This program does not perform any file I/O operations. All data exchange occurs through:
- The linkage section parameter (LS-COMMIT-REQUEST)
- Embedded SQL statements to DB2

## SQL Operations

| Operation | SQL Statement | Purpose |
|-----------|---------------|---------|
| Commit | `COMMIT WORK` | Make all changes permanent |
| Rollback | `ROLLBACK WORK` | Undo all uncommitted changes |
| Savepoint | `SAVEPOINT :name ON ROLLBACK RETAIN CURSORS` | Create recovery point |
| Restore | `ROLLBACK TO SAVEPOINT :name` | Undo to savepoint |

## Dependencies

### Copybooks

- **SQLCA** - SQL Communication Area for DB2 status (SQLCODE, SQLSTATE)
- **DBPROC** - DB2 standard procedures and error handling structures
- **ERRHAND** - Standard error handling definitions (ERR-MESSAGE, ERR-TEXT, ERR-PROGRAM)

### Called Programs

- **ERRPROC** - Error processing and logging program (for invalid function codes)
- **DB2ERR** - DB2 error logging program (for SQL operation failures)

### Related Programs

Programs that share DB2-related copybooks and may use DB2CMT:
- **HISTLD00** - History load program (uses SQLCA, DBPROC, ERRHAND)
- **DB2CONN** - DB2 connection manager (uses SQLCA, DBPROC, ERRHAND)
- **DB2ERR** - DB2 error handler (uses SQLCA, DBPROC, ERRHAND)
- **DB2STAT** - DB2 status checker (uses SQLCA, DBPROC, ERRHAND)

## Technical Notes

### Savepoint with RETAIN CURSORS

The `ON ROLLBACK RETAIN CURSORS` clause in the SAVEPOINT statement ensures that if a `ROLLBACK TO SAVEPOINT` is executed:
- Cursor positions are preserved
- Open cursors remain open
- Processing can continue without re-opening and repositioning cursors

This is important for batch processing where cursors may be positioned mid-result-set.

### Commit Frequency Strategy

The conditional commit logic supports two strategies:

1. **Interval-based commits**: Set `LS-COMMIT-FREQ` to the desired interval (e.g., 1000) and increment `LS-RECORDS-PROC` for each record processed. Commits occur automatically when the threshold is reached.

2. **Forced commits**: Set `LS-FORCE-FLAG` to 'Y' to commit regardless of record count. Typically used at end-of-file or after critical operations.

### Return Codes

| Code | Meaning |
|------|---------|
| 0 | Successful operation |
| 8 | DB2 error (SQLCODE captured in LS-SQLCODE) |
| 12 | Severe error (invalid function code) |

### Host Variable Declaration

The `WS-SAVEPOINT-ID` field is declared within an `EXEC SQL BEGIN/END DECLARE SECTION` block, making it a valid DB2 host variable that can be used in SQL statements with the colon prefix (`:WS-SAVEPOINT-ID`).

### Thread Safety Considerations

Working storage counters (WS-COMMIT-COUNT, etc.) persist across calls within a single program execution. In CICS or multi-threaded environments, each task has its own working storage copy, ensuring thread safety.
